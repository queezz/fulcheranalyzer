
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>fulcheranalyzer.coronalmodel &#8212; Fulcher Analyzer  documentation</title>
<script>
  document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
  document.documentElement.dataset.theme = localStorage.getItem("theme") || "light"
</script>

  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=92025949c220c2e29695" rel="stylesheet">
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=92025949c220c2e29695" rel="stylesheet">


  <link rel="stylesheet"
    href="../../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/jupyter-sphinx.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/thebelab.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css" />

  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=92025949c220c2e29695">

    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/thebelab-helper.js"></script>
    <script src="../../_static/clipboard.min.js"></script>
    <script src="../../_static/copybutton.js"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../../_static/togglebutton.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="https://unpkg.com/@jupyter-widgets/html-manager@^0.20.0/dist/embed-amd.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<meta name="docsearch:language" content="None">
  </head>
  
  
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="180" data-default-mode="">
    <div class="bd-header-announcement container-fluid" id="banner">
      

    </div>

    
    <nav class="bd-header navbar navbar-light navbar-expand-lg bg-light fixed-top bd-navbar" id="navbar-main"><div class="bd-header__inner container-xl">

  <div id="navbar-start">
    
    
  


<a class="navbar-brand logo" href="../../index.html">
  
  
  
  
    <img src="../../_static/h2icon.png" class="logo__image only-light" alt="Logo image">
    <img src="../../_static/h2icon.png" class="logo__image only-dark" alt="Logo image">
  
  
    <p class="title logo__title">Fulcher Analyzer</p>
  
</a>
    
  </div>

  <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-collapsible" aria-controls="navbar-collapsible" aria-expanded="false" aria-label="Toggle navigation">
    <span class="fas fa-bars"></span>
  </button>

  
  <div id="navbar-collapsible" class="col-lg-9 collapse navbar-collapse">
    <div id="navbar-center" class="mr-auto">
      
      <div class="navbar-center-item">
        <ul id="navbar-main-elements" class="navbar-nav">
    <li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../examples/index.html">
  Examples
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../modules.html">
  fulcheranalyzer
 </a>
</li>

    
</ul>
      </div>
      
    </div>

    <div id="navbar-end">
      
      <div class="navbar-end-item">
        <span id="theme-switch" class="btn btn-sm btn-outline-primary navbar-btn rounded-circle">
    <a class="theme-switch" data-mode="light"><i class="fas fa-sun"></i></a>
    <a class="theme-switch" data-mode="dark"><i class="far fa-moon"></i></a>
    <a class="theme-switch" data-mode="auto"><i class="fas fa-adjust"></i></a>
</span>
      </div>
      
      <div class="navbar-end-item">
        <ul id="navbar-icon-links" class="navbar-nav" aria-label="Icon Links">
      </ul>
      </div>
      
    </div>
  </div>
</div>
    </nav>
    

    <div class="bd-container container-xl">
      <div class="bd-container__inner row">
          

<!-- Only show if we have sidebars configured, else just a small margin  -->
<div class="bd-sidebar-primary col-12 col-md-3 bd-sidebar">
  <div class="sidebar-start-items"><form class="bd-search d-flex align-items-center" action="../../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search the docs ..." aria-label="Search the docs ..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main navigation">
  <div class="bd-toc-item active">
    
  </div>
</nav>
  </div>
  <div class="sidebar-end-items">
  </div>
</div>


          


<div class="bd-sidebar-secondary d-none d-xl-block col-xl-2 bd-toc">
  
</div>


          
          
          <div class="bd-content col-12 col-md-9 col-xl-7">
              
              <article class="bd-article" role="main">
                
  <h1>Source code for fulcheranalyzer.coronalmodel</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span><span class="o">,</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">os.path</span> <span class="kn">import</span> <span class="n">join</span><span class="p">,</span> <span class="n">abspath</span>
<span class="kn">from</span> <span class="nn">._constants</span> <span class="kn">import</span> <span class="n">package_directory</span>

<span class="n">ABSOLUTESIGMA</span> <span class="o">=</span> <span class="kc">False</span>
<span class="n">MOLECULAR_DATA_FOLDER</span> <span class="o">=</span> <span class="n">abspath</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">package_directory</span><span class="p">,</span> <span class="s2">&quot;..&quot;</span><span class="p">,</span> <span class="s2">&quot;data_molecular&quot;</span><span class="p">))</span>
<span class="n">DATA_FOLDER</span> <span class="o">=</span> <span class="n">abspath</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">package_directory</span><span class="p">,</span> <span class="s2">&quot;..&quot;</span><span class="p">,</span> <span class="s2">&quot;data&quot;</span><span class="p">))</span>


<div class="viewcode-block" id="MolecularConstants"><a class="viewcode-back" href="../../fulcheranalyzer.coronalmodel.html#fulcheranalyzer.coronalmodel.MolecularConstants">[docs]</a><span class="k">class</span> <span class="nc">MolecularConstants</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Hydrogen Isotopolouges molecular constants</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;Molecular Constatns for Hydrogen Isotopologues&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">create_dataframes</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">calculate_tfrac</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">general_constants</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">calculate_all_E_rot</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">acoeff</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">load_corona_constants</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">load_wavelength_data</span><span class="p">()</span>

<div class="viewcode-block" id="MolecularConstants.general_constants"><a class="viewcode-back" href="../../fulcheranalyzer.coronalmodel.html#fulcheranalyzer.coronalmodel.MolecularConstants.general_constants">[docs]</a>    <span class="k">def</span> <span class="nf">general_constants</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Populate class with useful constants </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">eV_cm</span> <span class="o">=</span> <span class="mf">1.23984e-4</span>  <span class="c1"># eV/cm-1 wavenumber to eV</span></div>

<div class="viewcode-block" id="MolecularConstants.parse_data"><a class="viewcode-back" href="../../fulcheranalyzer.coronalmodel.html#fulcheranalyzer.coronalmodel.MolecularConstants.parse_data">[docs]</a>    <span class="k">def</span> <span class="nf">parse_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">s</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parse file with rotational constants</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">i</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">s</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">),</span>
            <span class="p">[</span><span class="s2">&quot;d3&quot;</span><span class="p">,</span> <span class="s2">&quot;a3&quot;</span><span class="p">,</span> <span class="s2">&quot;X&quot;</span><span class="p">],</span>
            <span class="p">[</span><span class="s2">&quot;we&quot;</span><span class="p">,</span> <span class="s2">&quot;wexe&quot;</span><span class="p">,</span> <span class="s2">&quot;Be&quot;</span><span class="p">,</span> <span class="s2">&quot;ae&quot;</span><span class="p">,</span> <span class="s2">&quot;De&quot;</span><span class="p">],</span>
        <span class="p">)</span></div>

    <span class="c1"># TODO: Move data to datafiles.</span>
<div class="viewcode-block" id="MolecularConstants.create_dataframes"><a class="viewcode-back" href="../../fulcheranalyzer.coronalmodel.html#fulcheranalyzer.coronalmodel.MolecularConstants.create_dataframes">[docs]</a>    <span class="k">def</span> <span class="nf">create_dataframes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; </span>
<span class="sd">        Data from Ishihara-s thesis </span>
<span class="sd">        [16]:  NIST Chemistry WebBook ( https://webbook.nist.gov/chemistry/form-ser/ )</span>
<span class="sd">        All constants have same energy unit: [1/cm].</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">h2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_data</span><span class="p">(</span>
            <span class="sd">&quot;&quot;&quot;2371.57 66.27 30.364 1.545 0.0191</span>
<span class="sd">               2664.83 71.65 34.216 1.671 0.0216</span>
<span class="sd">               4401.21 121.33 60.853 3.062 0.0471&quot;&quot;&quot;</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">d2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_data</span><span class="p">(</span>
            <span class="sd">&quot;&quot;&quot;1678.22 32.94 15.200 0.5520 0.0049</span>
<span class="sd">               1885.84 35.96 17.109 0.606 0.0055</span>
<span class="sd">               3115.50 61.82 30.443 1.0786 0.01141&quot;&quot;&quot;</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="MolecularConstants.tfrac"><a class="viewcode-back" href="../../fulcheranalyzer.coronalmodel.html#fulcheranalyzer.coronalmodel.MolecularConstants.tfrac">[docs]</a>    <span class="k">def</span> <span class="nf">tfrac</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">isotop</span><span class="o">=</span><span class="s2">&quot;d&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Temperature ratio for given vibrational number for d3 level</span>
<span class="sd">        calculated as ratio of rotational constants</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">isotop</span> <span class="o">==</span> <span class="s2">&quot;d&quot;</span><span class="p">:</span>
            <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">d2</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s2">&quot;X&quot;</span><span class="p">]</span>
            <span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">d2</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s2">&quot;d3&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">h2</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s2">&quot;X&quot;</span><span class="p">]</span>
            <span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">h2</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s2">&quot;d3&quot;</span><span class="p">]</span>
        <span class="k">return</span> <span class="p">((</span><span class="n">x</span><span class="p">[</span><span class="s2">&quot;Be&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">x</span><span class="p">[</span><span class="s2">&quot;ae&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">v</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s2">&quot;Be&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">x</span><span class="p">[</span><span class="s2">&quot;ae&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="mi">0</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">)))</span> <span class="o">*</span> <span class="p">(</span>
            <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s2">&quot;Be&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">x</span><span class="p">[</span><span class="s2">&quot;ae&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="mi">0</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s2">&quot;Be&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">d</span><span class="p">[</span><span class="s2">&quot;ae&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="mi">0</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">))</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="MolecularConstants.calculate_tfrac"><a class="viewcode-back" href="../../fulcheranalyzer.coronalmodel.html#fulcheranalyzer.coronalmodel.MolecularConstants.calculate_tfrac">[docs]</a>    <span class="k">def</span> <span class="nf">calculate_tfrac</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vmax</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Temperature ratios DataFrame for H and D</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">frac</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">tfrac</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">isotop</span><span class="o">=</span><span class="s2">&quot;d&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">vmax</span><span class="p">)]),</span>
                <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">tfrac</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">isotop</span><span class="o">=</span><span class="s2">&quot;h&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">vmax</span><span class="p">)]),</span>
            <span class="p">],</span>
            <span class="p">[</span><span class="s2">&quot;d&quot;</span><span class="p">,</span> <span class="s2">&quot;h&quot;</span><span class="p">],</span>
        <span class="p">)</span><span class="o">.</span><span class="n">T</span>
        <span class="k">if</span> <span class="n">norm</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">frac</span> <span class="o">=</span> <span class="n">frac</span> <span class="o">/</span> <span class="n">frac</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">frac</span> <span class="o">=</span> <span class="n">frac</span></div>

<div class="viewcode-block" id="MolecularConstants.load_wavelength_data"><a class="viewcode-back" href="../../fulcheranalyzer.coronalmodel.html#fulcheranalyzer.coronalmodel.MolecularConstants.load_wavelength_data">[docs]</a>    <span class="k">def</span> <span class="nf">load_wavelength_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Load wavelength data for Q-branch for H and D</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Deuterium, data in the file is in [cm^{-1}], 800 is nan</span>
        <span class="n">wld</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span>
            <span class="n">join</span><span class="p">(</span><span class="n">MOLECULAR_DATA_FOLDER</span><span class="p">,</span> <span class="s2">&quot;fulcher-α_band_wavenumber_D2.txt&quot;</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">wld</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="n">wld</span> <span class="o">*</span> <span class="mf">1e-7</span><span class="p">))</span>  <span class="c1"># wavenumber [cm-1] -&gt; wavelength [nm]</span>
        <span class="n">wld</span><span class="p">[</span><span class="n">wld</span> <span class="o">&gt;</span> <span class="mi">800</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wld</span> <span class="o">=</span> <span class="n">wld</span>
        <span class="n">wlh</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">MOLECULAR_DATA_FOLDER</span><span class="p">,</span> <span class="s2">&quot;fulcher-α_band_wavelength.txt&quot;</span><span class="p">))</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wlh</span> <span class="o">=</span> <span class="n">wlh</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wlh</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">wlh</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span></div>

<div class="viewcode-block" id="MolecularConstants.E_rot_formula"><a class="viewcode-back" href="../../fulcheranalyzer.coronalmodel.html#fulcheranalyzer.coronalmodel.MolecularConstants.E_rot_formula">[docs]</a>    <span class="k">def</span> <span class="nf">E_rot_formula</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">J</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">isotop</span><span class="o">=</span><span class="s2">&quot;d&quot;</span><span class="p">,</span> <span class="n">state</span><span class="o">=</span><span class="s2">&quot;d3&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Rotational energy formula</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">Be</span><span class="p">,</span> <span class="n">ae</span><span class="p">,</span> <span class="n">De</span> <span class="o">=</span> <span class="n">c</span>
        <span class="n">B</span> <span class="o">=</span> <span class="n">Be</span> <span class="o">-</span> <span class="n">ae</span> <span class="o">*</span> <span class="p">(</span><span class="n">v</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">B</span> <span class="o">*</span> <span class="n">J</span> <span class="o">*</span> <span class="p">(</span><span class="n">J</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="n">De</span> <span class="o">*</span> <span class="n">J</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">J</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">eV_cm</span></div>

<div class="viewcode-block" id="MolecularConstants.calculate_E_rot"><a class="viewcode-back" href="../../fulcheranalyzer.coronalmodel.html#fulcheranalyzer.coronalmodel.MolecularConstants.calculate_E_rot">[docs]</a>    <span class="k">def</span> <span class="nf">calculate_E_rot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vlen</span><span class="p">,</span> <span class="n">Jlen</span><span class="p">,</span> <span class="n">isotop</span><span class="o">=</span><span class="s2">&quot;d&quot;</span><span class="p">,</span> <span class="n">state</span><span class="o">=</span><span class="s2">&quot;d3&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Fill DataFrame with rotational energies for given isotope and state</span>
<span class="sd">        [En] isotope [Ru] isotop</span>
<span class="sd">        NOTE:</span>
<span class="sd">        For d-state: J starts from 1.</span>
<span class="sd">        For X-state: J must start from 0.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">state</span> <span class="o">==</span> <span class="s2">&quot;d3&quot;</span><span class="p">:</span>
            <span class="n">J0</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">state</span> <span class="o">==</span> <span class="s2">&quot;X&quot;</span><span class="p">:</span>
            <span class="n">J0</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">isotop</span> <span class="o">==</span> <span class="s2">&quot;d&quot;</span><span class="p">:</span>
            <span class="n">m</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">d2</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">m</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">h2</span>

        <span class="n">Be</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">state</span><span class="p">,</span> <span class="s2">&quot;Be&quot;</span><span class="p">]</span>  <span class="c1"># rotational constant</span>
        <span class="n">ae</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">state</span><span class="p">,</span> <span class="s2">&quot;ae&quot;</span><span class="p">]</span>  <span class="c1"># ro-vib interaction constant</span>
        <span class="n">De</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">state</span><span class="p">,</span> <span class="s2">&quot;De&quot;</span><span class="p">]</span>  <span class="c1"># centrifugal distortion constant</span>
        <span class="n">c</span> <span class="o">=</span> <span class="p">(</span><span class="n">Be</span><span class="p">,</span> <span class="n">ae</span><span class="p">,</span> <span class="n">De</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="p">[</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">E_rot_formula</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">J</span> <span class="o">+</span> <span class="n">J0</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">isotop</span><span class="o">=</span><span class="n">isotop</span><span class="p">,</span> <span class="n">state</span><span class="o">=</span><span class="n">state</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">vlen</span><span class="p">)</span>
                <span class="p">]</span>
                <span class="k">for</span> <span class="n">J</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Jlen</span><span class="p">)</span>
            <span class="p">]</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="MolecularConstants.E_vib_formula"><a class="viewcode-back" href="../../fulcheranalyzer.coronalmodel.html#fulcheranalyzer.coronalmodel.MolecularConstants.E_vib_formula">[docs]</a>    <span class="k">def</span> <span class="nf">E_vib_formula</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">c</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Vibrational energy formula</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">we</span><span class="p">,</span> <span class="n">wexe</span> <span class="o">=</span> <span class="n">c</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">we</span> <span class="o">*</span> <span class="p">(</span><span class="n">v</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">)</span> <span class="o">-</span> <span class="n">wexe</span> <span class="o">*</span> <span class="p">(</span><span class="n">v</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">eV_cm</span></div>

<div class="viewcode-block" id="MolecularConstants.calculate_E_vib"><a class="viewcode-back" href="../../fulcheranalyzer.coronalmodel.html#fulcheranalyzer.coronalmodel.MolecularConstants.calculate_E_vib">[docs]</a>    <span class="k">def</span> <span class="nf">calculate_E_vib</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">state</span><span class="o">=</span><span class="s2">&quot;d3&quot;</span><span class="p">,</span> <span class="n">isotop</span><span class="o">=</span><span class="s2">&quot;d&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate an array of vibrational energy</span>
<span class="sd">        vmax - maximum vibrational q.n. in the array</span>
<span class="sd">        state - electronic state, &#39;X&#39;, &#39;d3&#39;, &#39;a3&#39;</span>
<span class="sd">        isotop - isotopologue, &#39;d&#39; - D2, &#39;h&#39; - H2</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">isotop</span> <span class="o">==</span> <span class="s2">&quot;d&quot;</span><span class="p">:</span>
            <span class="n">m</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">d2</span>
        <span class="k">if</span> <span class="n">isotop</span> <span class="o">==</span> <span class="s2">&quot;h&quot;</span><span class="p">:</span>
            <span class="n">m</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">h2</span>
        <span class="n">we</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">state</span><span class="p">,</span> <span class="s2">&quot;we&quot;</span><span class="p">]</span>
        <span class="n">wexe</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">state</span><span class="p">,</span> <span class="s2">&quot;wexe&quot;</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">E_vib_formula</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="p">[</span><span class="n">we</span><span class="p">,</span> <span class="n">wexe</span><span class="p">])</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">vmax</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)])</span></div>

<div class="viewcode-block" id="MolecularConstants.calculate_all_E_rot"><a class="viewcode-back" href="../../fulcheranalyzer.coronalmodel.html#fulcheranalyzer.coronalmodel.MolecularConstants.calculate_all_E_rot">[docs]</a>    <span class="k">def</span> <span class="nf">calculate_all_E_rot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vlen</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">Jlen</span><span class="o">=</span><span class="mi">14</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate rotational energy arrays for X, d states for H and D</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">EdH</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_E_rot</span><span class="p">(</span><span class="n">vlen</span><span class="p">,</span> <span class="n">Jlen</span><span class="p">,</span> <span class="n">isotop</span><span class="o">=</span><span class="s2">&quot;h&quot;</span><span class="p">,</span> <span class="n">state</span><span class="o">=</span><span class="s2">&quot;d3&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ExH</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_E_rot</span><span class="p">(</span><span class="n">vlen</span><span class="p">,</span> <span class="n">Jlen</span><span class="p">,</span> <span class="n">isotop</span><span class="o">=</span><span class="s2">&quot;h&quot;</span><span class="p">,</span> <span class="n">state</span><span class="o">=</span><span class="s2">&quot;X&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">EdD</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_E_rot</span><span class="p">(</span><span class="n">vlen</span><span class="p">,</span> <span class="n">Jlen</span><span class="p">,</span> <span class="n">isotop</span><span class="o">=</span><span class="s2">&quot;d&quot;</span><span class="p">,</span> <span class="n">state</span><span class="o">=</span><span class="s2">&quot;d3&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ExD</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_E_rot</span><span class="p">(</span><span class="n">vlen</span><span class="p">,</span> <span class="n">Jlen</span><span class="p">,</span> <span class="n">isotop</span><span class="o">=</span><span class="s2">&quot;d&quot;</span><span class="p">,</span> <span class="n">state</span><span class="o">=</span><span class="s2">&quot;X&quot;</span><span class="p">)</span></div>

    <span class="c1"># TODO: Move data to datafiles. Add data reference to the source.</span>
<div class="viewcode-block" id="MolecularConstants.acoeff"><a class="viewcode-back" href="../../fulcheranalyzer.coronalmodel.html#fulcheranalyzer.coronalmodel.MolecularConstants.acoeff">[docs]</a>    <span class="k">def</span> <span class="nf">acoeff</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Populate Acoeff for D2 and H2</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Deuterium</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">AD</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="p">[</span>
                    <span class="mf">2.3387e07</span><span class="p">,</span>
                    <span class="mf">2.3479e06</span><span class="p">,</span>
                    <span class="mf">3.9083e04</span><span class="p">,</span>
                    <span class="mf">6.9282e01</span><span class="p">,</span>
                    <span class="mf">6.7372e-02</span><span class="p">,</span>
                    <span class="mf">1.9986e-02</span><span class="p">,</span>
                    <span class="mf">2.9027e-04</span><span class="p">,</span>
                    <span class="mf">7.7599e-03</span><span class="p">,</span>
                <span class="p">],</span>
                <span class="p">[</span>
                    <span class="mf">2.1551e06</span><span class="p">,</span>
                    <span class="mf">1.8841e07</span><span class="p">,</span>
                    <span class="mf">4.4730e06</span><span class="p">,</span>
                    <span class="mf">1.2747e05</span><span class="p">,</span>
                    <span class="mf">2.7294e02</span><span class="p">,</span>
                    <span class="mf">4.3313e-01</span><span class="p">,</span>
                    <span class="mf">3.4305e-02</span><span class="p">,</span>
                    <span class="mf">3.5382e-02</span><span class="p">,</span>
                <span class="p">],</span>
                <span class="p">[</span>
                    <span class="mf">1.8763e05</span><span class="p">,</span>
                    <span class="mf">3.8098e06</span><span class="p">,</span>
                    <span class="mf">1.4795e07</span><span class="p">,</span>
                    <span class="mf">6.3500e06</span><span class="p">,</span>
                    <span class="mf">2.4539e05</span><span class="p">,</span>
                    <span class="mf">6.9366e02</span><span class="p">,</span>
                    <span class="mf">2.0363e00</span><span class="p">,</span>
                    <span class="mf">2.0664e-03</span><span class="p">,</span>
                <span class="p">],</span>
                <span class="p">[</span>
                    <span class="mf">1.7678e04</span><span class="p">,</span>
                    <span class="mf">5.2206e05</span><span class="p">,</span>
                    <span class="mf">4.9835e06</span><span class="p">,</span>
                    <span class="mf">1.1276e07</span><span class="p">,</span>
                    <span class="mf">7.9698e06</span><span class="p">,</span>
                    <span class="mf">4.1361e05</span><span class="p">,</span>
                    <span class="mf">1.3613e03</span><span class="p">,</span>
                    <span class="mf">6.0937e00</span><span class="p">,</span>
                <span class="p">],</span>
            <span class="p">]</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ADsum</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">AD</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">values</span>
        <span class="c1"># Hydrogen</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">AH</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="p">(</span>
                    <span class="mf">2.4077e7</span><span class="p">,</span>
                    <span class="mf">1.6552e6</span><span class="p">,</span>
                    <span class="mf">9.2743e3</span><span class="p">,</span>
                    <span class="mf">7.7501e-2</span><span class="p">,</span>
                    <span class="mf">5.6159e-2</span><span class="p">,</span>
                    <span class="mf">2.1645e-5</span><span class="p">,</span>
                    <span class="mf">1.2126e-4</span><span class="p">,</span>
                    <span class="mf">2.4635e-4</span><span class="p">,</span>
                <span class="p">),</span>
                <span class="p">(</span>
                    <span class="mf">1.5258e6</span><span class="p">,</span>
                    <span class="mf">2.0655e7</span><span class="p">,</span>
                    <span class="mf">3.2649e6</span><span class="p">,</span>
                    <span class="mf">2.9732e4</span><span class="p">,</span>
                    <span class="mf">2.8248e0</span><span class="p">,</span>
                    <span class="mf">1.8340e-1</span><span class="p">,</span>
                    <span class="mf">4.0941e-6</span><span class="p">,</span>
                    <span class="mf">4.9920e-3</span><span class="p">,</span>
                <span class="p">),</span>
                <span class="p">(</span>
                    <span class="mf">1.0712e5</span><span class="p">,</span>
                    <span class="mf">2.8369e6</span><span class="p">,</span>
                    <span class="mf">1.7377e7</span><span class="p">,</span>
                    <span class="mf">4.7993e6</span><span class="p">,</span>
                    <span class="mf">6.2309e4</span><span class="p">,</span>
                    <span class="mf">2.1093e1</span><span class="p">,</span>
                    <span class="mf">6.3848e-1</span><span class="p">,</span>
                    <span class="mf">1.1783e-2</span><span class="p">,</span>
                <span class="p">),</span>
                <span class="p">(</span>
                    <span class="mf">8.3952e3</span><span class="p">,</span>
                    <span class="mf">3.1899e5</span><span class="p">,</span>
                    <span class="mf">3.8874e6</span><span class="p">,</span>
                    <span class="mf">1.4317e7</span><span class="p">,</span>
                    <span class="mf">6.2363e6</span><span class="p">,</span>
                    <span class="mf">1.0633e5</span><span class="p">,</span>
                    <span class="mf">1.0579e2</span><span class="p">,</span>
                    <span class="mf">1.8096e0</span><span class="p">,</span>
                <span class="p">),</span>
            <span class="p">]</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">AHsum</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">AH</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">values</span></div>

<div class="viewcode-block" id="MolecularConstants.calculate_spin_multiplicity"><a class="viewcode-back" href="../../fulcheranalyzer.coronalmodel.html#fulcheranalyzer.coronalmodel.MolecularConstants.calculate_spin_multiplicity">[docs]</a>    <span class="k">def</span> <span class="nf">calculate_spin_multiplicity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Jmax</span><span class="o">=</span><span class="mi">13</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate spin multiplicity vectors for D2 and H2</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gas_d2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">6</span> <span class="o">-</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">mod</span><span class="p">((</span><span class="n">J</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span> <span class="k">for</span> <span class="n">J</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Jmax</span><span class="p">)])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gas_h2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">mod</span><span class="p">((</span><span class="n">J</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span> <span class="k">for</span> <span class="n">J</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Jmax</span><span class="p">)])</span></div>

<div class="viewcode-block" id="MolecularConstants.load_corona_constants"><a class="viewcode-back" href="../../fulcheranalyzer.coronalmodel.html#fulcheranalyzer.coronalmodel.MolecularConstants.load_corona_constants">[docs]</a>    <span class="k">def</span> <span class="nf">load_corona_constants</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Load constants for cornal model</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Deuterium</span>
        <span class="c1"># vibrational energy</span>
        <span class="n">E_vib</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">MOLECULAR_DATA_FOLDER</span><span class="p">,</span> <span class="s2">&quot;vibrational_energy_D2.txt&quot;</span><span class="p">))</span>
        <span class="c1"># excitation energy for vibrational levels</span>
        <span class="n">Ee_vib</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span>
            <span class="n">join</span><span class="p">(</span><span class="n">MOLECULAR_DATA_FOLDER</span><span class="p">,</span> <span class="s2">&quot;excitation_vibrational_energy_D2.txt&quot;</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="c1"># Franck-Condon factors</span>
        <span class="n">fcf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">MOLECULAR_DATA_FOLDER</span><span class="p">,</span> <span class="s2">&quot;franck_condon_factor_D2.txt&quot;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">corona_constants_d</span> <span class="o">=</span> <span class="p">[</span><span class="n">E_vib</span><span class="p">,</span> <span class="n">Ee_vib</span><span class="p">,</span> <span class="n">fcf</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fcfd</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">fcf</span><span class="p">)</span>

        <span class="c1"># Hydrogen</span>
        <span class="c1"># vibrational energy</span>
        <span class="n">E_vib</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">MOLECULAR_DATA_FOLDER</span><span class="p">,</span> <span class="s2">&quot;vibrational_energy.txt&quot;</span><span class="p">))</span>
        <span class="c1"># excitation energy for vibrational levels</span>
        <span class="n">Ee_vib</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span>
            <span class="n">join</span><span class="p">(</span><span class="n">MOLECULAR_DATA_FOLDER</span><span class="p">,</span> <span class="s2">&quot;excitation_vibrational_energy.txt&quot;</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="c1"># Franck-Condon factors</span>
        <span class="n">fcf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">MOLECULAR_DATA_FOLDER</span><span class="p">,</span> <span class="s2">&quot;franck_condon_factor.txt&quot;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">corona_constants_h</span> <span class="o">=</span> <span class="p">[</span><span class="n">E_vib</span><span class="p">,</span> <span class="n">Ee_vib</span><span class="p">,</span> <span class="n">fcf</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fcfh</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">fcf</span><span class="p">)</span></div></div>


<span class="c1"># ==================================================</span>
<span class="c1">#</span>
<span class="c1"># Convenience functions and fitting functions for Boltzmann plot</span>
<span class="c1">#</span>
<span class="c1"># ==================================================</span>


<div class="viewcode-block" id="expsum"><a class="viewcode-back" href="../../fulcheranalyzer.coronalmodel.html#fulcheranalyzer.coronalmodel.expsum">[docs]</a><span class="k">def</span> <span class="nf">expsum</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">T1</span><span class="p">,</span> <span class="n">T2</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">constant</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Mixing of two Boltzman distributions</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">scipy.constants</span> <span class="kn">import</span> <span class="n">Boltzmann</span><span class="p">,</span> <span class="n">elementary_charge</span>

    <span class="n">kb</span> <span class="o">=</span> <span class="n">Boltzmann</span> <span class="o">/</span> <span class="n">elementary_charge</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
        <span class="n">constant</span> <span class="o">*</span> <span class="p">((</span><span class="mi">1</span> <span class="o">-</span> <span class="n">a</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">e</span> <span class="o">/</span> <span class="p">(</span><span class="n">kb</span> <span class="o">*</span> <span class="n">T1</span><span class="p">))</span> <span class="o">+</span> <span class="n">a</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">e</span> <span class="o">/</span> <span class="p">(</span><span class="n">kb</span> <span class="o">*</span> <span class="n">T2</span><span class="p">)))</span>
    <span class="p">)</span></div>


<div class="viewcode-block" id="two_t_all_v"><a class="viewcode-back" href="../../fulcheranalyzer.coronalmodel.html#fulcheranalyzer.coronalmodel.two_t_all_v">[docs]</a><span class="k">def</span> <span class="nf">two_t_all_v</span><span class="p">(</span><span class="n">Erot</span><span class="p">,</span> <span class="o">*</span><span class="n">param</span><span class="p">,</span> <span class="o">**</span><span class="n">kws</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Constract two exponent distribution for all vibrational transitions</span>
<span class="sd">    populate DataFrame</span>
<span class="sd">    a, b - exponent multiplyers for v=0 and others, v&gt;0 assumed to have same multiplier</span>
<span class="sd">    T1, T2 - temperatures of the two exponents</span>
<span class="sd">    cs - tuple of constants for all v.     </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">T1</span><span class="p">,</span> <span class="n">T2</span> <span class="o">=</span> <span class="n">param</span><span class="p">[:</span><span class="mi">4</span><span class="p">]</span>
    <span class="n">cs</span> <span class="o">=</span> <span class="n">param</span><span class="p">[</span><span class="mi">4</span><span class="p">:]</span>
    <span class="n">aps</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">b</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Erot</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)]</span>
    <span class="c1"># temperature fractions</span>
    <span class="n">mol</span> <span class="o">=</span> <span class="n">MolecularConstants</span><span class="p">()</span>
    <span class="n">mol</span><span class="o">.</span><span class="n">calculate_tfrac</span><span class="p">(</span>
        <span class="n">Erot</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">norm</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">)</span>  <span class="c1"># norm=True is essential! Otherwise produces T2*2.</span>
    <span class="n">isotop</span> <span class="o">=</span> <span class="n">kws</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;isotop&quot;</span><span class="p">,</span> <span class="s2">&quot;d&quot;</span><span class="p">)</span>
    <span class="n">tfrac</span> <span class="o">=</span> <span class="n">mol</span><span class="o">.</span><span class="n">frac</span><span class="p">[</span><span class="n">isotop</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
    <span class="n">ns</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
        <span class="p">[</span>
            <span class="n">expsum</span><span class="p">(</span><span class="n">Erot</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">tc</span> <span class="o">*</span> <span class="n">T1</span><span class="p">,</span> <span class="n">tc</span> <span class="o">*</span> <span class="n">T2</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">tc</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">tfrac</span><span class="p">,</span> <span class="n">aps</span><span class="p">,</span> <span class="n">Erot</span><span class="p">,</span> <span class="n">cs</span><span class="p">)</span>
        <span class="p">]</span>
    <span class="p">)</span><span class="o">.</span><span class="n">T</span>
    <span class="n">melt</span> <span class="o">=</span> <span class="n">kws</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;melt&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">melt</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">flatdf</span><span class="p">(</span><span class="n">ns</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">ns</span></div>


<div class="viewcode-block" id="plot_n_all_v"><a class="viewcode-back" href="../../fulcheranalyzer.coronalmodel.html#fulcheranalyzer.coronalmodel.plot_n_all_v">[docs]</a><span class="k">def</span> <span class="nf">plot_n_all_v</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">E</span><span class="p">,</span> <span class="o">**</span><span class="n">kws</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    input: experimental populations in [2D] DataFrame with missing values as NaN</span>
<span class="sd">    Energy - full DataFrame with theoretical rotational energy E</span>
<span class="sd">    cycles through columns in n (corresponding to vibrational level), removes nans,</span>
<span class="sd">    and plots</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">matplotlib.pyplot</span> <span class="kn">import</span> <span class="n">plot</span>

    <span class="n">nomarker</span> <span class="o">=</span> <span class="n">kws</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;nomarker&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
    <span class="n">noline</span> <span class="o">=</span> <span class="n">kws</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;noline&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
    <span class="n">mkws</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span><span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;v&#39;=</span><span class="si">{</span><span class="n">l</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;marker&quot;</span><span class="p">:</span> <span class="n">m</span><span class="p">,</span> <span class="s2">&quot;ls&quot;</span><span class="p">:</span> <span class="s2">&quot;--&quot;</span><span class="p">}</span>
        <span class="k">for</span> <span class="n">l</span><span class="p">,</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span> <span class="p">[</span><span class="s2">&quot;s&quot;</span><span class="p">,</span> <span class="s2">&quot;o&quot;</span><span class="p">,</span> <span class="s2">&quot;d&quot;</span><span class="p">,</span> <span class="s2">&quot;x&quot;</span><span class="p">])</span>
    <span class="p">]</span>
    <span class="k">if</span> <span class="n">nomarker</span><span class="p">:</span>
        <span class="n">mkws</span> <span class="o">=</span> <span class="p">[{</span><span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;v&#39;=</span><span class="si">{</span><span class="n">l</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;ls&quot;</span><span class="p">:</span> <span class="s2">&quot;--&quot;</span><span class="p">}</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">)]</span>
    <span class="k">if</span> <span class="n">noline</span><span class="p">:</span>
        <span class="n">mkws</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">{</span><span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;v&#39;=</span><span class="si">{</span><span class="n">l</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;marker&quot;</span><span class="p">:</span> <span class="n">m</span><span class="p">,</span> <span class="s2">&quot;ls&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">}</span>
            <span class="k">for</span> <span class="n">l</span><span class="p">,</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span> <span class="p">[</span><span class="s2">&quot;s&quot;</span><span class="p">,</span> <span class="s2">&quot;o&quot;</span><span class="p">,</span> <span class="s2">&quot;d&quot;</span><span class="p">,</span> <span class="s2">&quot;x&quot;</span><span class="p">])</span>
        <span class="p">]</span>

    <span class="n">log</span> <span class="o">=</span> <span class="n">kws</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;log&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">p</span><span class="p">,</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">E</span><span class="p">)):</span>
        <span class="n">m</span> <span class="o">=</span> <span class="o">~</span><span class="n">pd</span><span class="o">.</span><span class="n">isna</span><span class="p">(</span><span class="n">n</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">log</span><span class="p">:</span>
            <span class="n">plot</span><span class="p">(</span><span class="n">E</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="n">m</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">n</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">m</span><span class="p">]),</span> <span class="o">**</span><span class="n">mkws</span><span class="p">[</span><span class="n">p</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">plot</span><span class="p">(</span><span class="n">E</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="n">m</span><span class="p">],</span> <span class="n">n</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">m</span><span class="p">],</span> <span class="o">**</span><span class="n">mkws</span><span class="p">[</span><span class="n">p</span><span class="p">])</span></div>


<div class="viewcode-block" id="fittext"><a class="viewcode-back" href="../../fulcheranalyzer.coronalmodel.html#fulcheranalyzer.coronalmodel.fittext">[docs]</a><span class="k">def</span> <span class="nf">fittext</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return text for matplotlib plot with fitting parameters, a,b,T1,T2 from two_t_all_v()</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;$</span><span class="se">\\</span><span class="s2">alpha=</span><span class="si">{</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">$ $</span><span class="se">\\</span><span class="s2">beta=</span><span class="si">{</span><span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">$ $T_1=</span><span class="si">{</span><span class="n">p</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="si">:</span><span class="s2">.0f</span><span class="si">}</span><span class="s2">$K $T_2=</span><span class="si">{</span><span class="n">p</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="si">:</span><span class="s2">.0f</span><span class="si">}</span><span class="s2">$K&quot;</span>
    <span class="p">)</span></div>


<span class="c1"># ==================================================</span>
<span class="c1">#</span>
<span class="c1">#  Work with fitted line intensities</span>
<span class="c1">#</span>
<span class="c1"># ==================================================</span>


<div class="viewcode-block" id="write_intensities"><a class="viewcode-back" href="../../fulcheranalyzer.coronalmodel.html#fulcheranalyzer.coronalmodel.write_intensities">[docs]</a><span class="k">def</span> <span class="nf">write_intensities</span><span class="p">(</span><span class="n">inte</span><span class="p">,</span> <span class="o">*</span><span class="n">arg</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Save intensites for a given shot and given frame</span>
<span class="sd">    in a `*.csv` file in `DATA_FOLDER` subfolder</span>
<span class="sd">    intensities in pandas.DataFrame, columns: v-v (vibrational q.n.),</span>
<span class="sd">    rows: J (rotational q.n.).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">shot</span><span class="p">,</span> <span class="n">frame</span><span class="p">,</span> <span class="n">gas</span> <span class="o">=</span> <span class="n">arg</span>
    <span class="n">fpth</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">DATA_FOLDER</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">shot</span><span class="si">}</span><span class="s2">_fr_</span><span class="si">{</span><span class="n">frame</span><span class="si">}</span><span class="s2">.csv&quot;</span><span class="p">)</span>
    <span class="c1"># write header</span>
    <span class="n">txt</span> <span class="o">=</span> <span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;# shotnumber: </span><span class="si">{</span><span class="n">shot</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="sa">f</span><span class="s2">&quot;# frame : </span><span class="si">{</span><span class="n">frame</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="sa">f</span><span class="s2">&quot;# gas : </span><span class="si">{</span><span class="n">gas</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;# Columns: vibrational quantum number</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;# Rows: rotational quantum number</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;# Values: Q-branch line intensities [unit]</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;# [Data]</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">fpth</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">txt</span><span class="p">)</span>
    <span class="c1"># and then data</span>
    <span class="n">inte</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">fpth</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></div>


<div class="viewcode-block" id="read_intensities"><a class="viewcode-back" href="../../fulcheranalyzer.coronalmodel.html#fulcheranalyzer.coronalmodel.read_intensities">[docs]</a><span class="k">def</span> <span class="nf">read_intensities</span><span class="p">(</span><span class="n">shot</span><span class="p">,</span> <span class="n">frame</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Read intensities</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">fpth</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">DATA_FOLDER</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">shot</span><span class="si">}</span><span class="s2">_fr_</span><span class="si">{</span><span class="n">frame</span><span class="si">}</span><span class="s2">.csv&quot;</span><span class="p">)</span>
    <span class="n">ferr</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">DATA_FOLDER</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">shot</span><span class="si">}</span><span class="s2">_fr_</span><span class="si">{</span><span class="n">frame</span><span class="si">}</span><span class="s2">_err.csv&quot;</span><span class="p">)</span>
    <span class="n">inte</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">fpth</span><span class="p">,</span> <span class="n">comment</span><span class="o">=</span><span class="s2">&quot;#&quot;</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">interr</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">ferr</span><span class="p">,</span> <span class="n">comment</span><span class="o">=</span><span class="s2">&quot;#&quot;</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;no error data was found&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">inte</span><span class="p">,</span> <span class="n">inte</span> <span class="o">*</span> <span class="mf">0.1</span>
    <span class="k">return</span> <span class="n">inte</span><span class="p">,</span> <span class="n">interr</span></div>


<span class="c1"># ==================================================</span>
<span class="c1">#</span>
<span class="c1">#  Boltzmann Plot and fit class</span>
<span class="c1">#</span>
<span class="c1"># ==================================================</span>


<div class="viewcode-block" id="BoltzmannPlot"><a class="viewcode-back" href="../../fulcheranalyzer.coronalmodel.html#fulcheranalyzer.coronalmodel.BoltzmannPlot">[docs]</a><span class="k">class</span> <span class="nc">BoltzmannPlot</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;&quot;</span>
<span class="sd">    Analysis of Boltzmann distribution</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inte</span><span class="p">,</span> <span class="n">isotop</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; </span>
<span class="sd">        Supply intensity DataFrame</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        inte: </span>

<span class="sd">        isotop: string</span>
<span class="sd">             &#39;d&#39; or &#39;h&#39; for deuterium and hydrogen, respectively.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;Analysis of Boltzmann distribution&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inte</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">interr</span> <span class="o">=</span> <span class="n">inte</span>
        <span class="n">isotops</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;h&quot;</span><span class="p">,</span> <span class="s2">&quot;d&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">isotop</span> <span class="ow">in</span> <span class="n">isotops</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;isotop must be one of the </span><span class="si">{</span><span class="n">isotops</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">isotop</span> <span class="o">=</span> <span class="n">isotop</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">load_wavelength_data</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trim_wavelength</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prep_mol</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bplot_constants</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">calculate_boltzmann</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prep_fit</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_style</span><span class="p">()</span>

    <span class="c1"># TODO: Move to MolecularConstants class</span>
<div class="viewcode-block" id="BoltzmannPlot.load_wavelength_data"><a class="viewcode-back" href="../../fulcheranalyzer.coronalmodel.html#fulcheranalyzer.coronalmodel.BoltzmannPlot.load_wavelength_data">[docs]</a>    <span class="k">def</span> <span class="nf">load_wavelength_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; </span>
<span class="sd">        Load wavelength data for Q-branch for H and D </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Deuterium, data in the file is in [cm^{-1}], 800 is nan</span>
        <span class="n">wld</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span>
            <span class="n">join</span><span class="p">(</span><span class="n">MOLECULAR_DATA_FOLDER</span><span class="p">,</span> <span class="s2">&quot;fulcher-α_band_wavenumber_D2.txt&quot;</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">wld</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="n">wld</span> <span class="o">*</span> <span class="mf">1e-7</span><span class="p">))</span>  <span class="c1"># wavenumber [cm-1] -&gt; wavelength [nm]</span>
        <span class="n">wld</span><span class="p">[</span><span class="n">wld</span> <span class="o">&gt;</span> <span class="mi">800</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wld</span> <span class="o">=</span> <span class="n">wld</span>
        <span class="n">wlh</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">MOLECULAR_DATA_FOLDER</span><span class="p">,</span> <span class="s2">&quot;fulcher-α_band_wavelength.txt&quot;</span><span class="p">))</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wlh</span> <span class="o">=</span> <span class="n">wlh</span></div>

<div class="viewcode-block" id="BoltzmannPlot.trim_wavelength"><a class="viewcode-back" href="../../fulcheranalyzer.coronalmodel.html#fulcheranalyzer.coronalmodel.BoltzmannPlot.trim_wavelength">[docs]</a>    <span class="k">def</span> <span class="nf">trim_wavelength</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Match wavelength DataFrame shape with Intensities Dataframe shape.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">isotop</span> <span class="o">==</span> <span class="s2">&quot;d&quot;</span><span class="p">:</span>
            <span class="n">wl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wld</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">isotop</span> <span class="o">==</span> <span class="s2">&quot;h&quot;</span><span class="p">:</span>
            <span class="n">wl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wlh</span>

        <span class="k">if</span> <span class="n">wl</span><span class="o">.</span><span class="n">shape</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">inte</span><span class="o">.</span><span class="n">shape</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;Wavelength data shape is smaller than intensity data shape. &quot;</span>
                <span class="s2">&quot;Either reduce intensity DataFrame size, or add missing Wavelength data.&quot;</span>
            <span class="p">)</span>

        <span class="c1"># drop rows</span>
        <span class="n">w</span> <span class="o">=</span> <span class="n">wl</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">wl</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="nb">range</span><span class="p">(</span><span class="n">wl</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">inte</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)])</span>
        <span class="c1"># drop columns</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wl</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span>
            <span class="n">columns</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">wl</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">inte</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="BoltzmannPlot.prep_mol"><a class="viewcode-back" href="../../fulcheranalyzer.coronalmodel.html#fulcheranalyzer.coronalmodel.BoltzmannPlot.prep_mol">[docs]</a>    <span class="k">def</span> <span class="nf">prep_mol</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        load molecular data class and adjust DataFrame shapes </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mol</span> <span class="o">=</span> <span class="n">MolecularConstants</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mol</span><span class="o">.</span><span class="n">calculate_tfrac</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inte</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">norm</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mol</span><span class="o">.</span><span class="n">calculate_all_E_rot</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">inte</span><span class="o">.</span><span class="n">shape</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">isotop</span> <span class="o">==</span> <span class="s2">&quot;d&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Ed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mol</span><span class="o">.</span><span class="n">EdD</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">EX</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mol</span><span class="o">.</span><span class="n">ExD</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Aev</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mol</span><span class="o">.</span><span class="n">AD</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">isotop</span> <span class="o">==</span> <span class="s2">&quot;h&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Ed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mol</span><span class="o">.</span><span class="n">EdH</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">EX</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mol</span><span class="o">.</span><span class="n">ExH</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Aev</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mol</span><span class="o">.</span><span class="n">AH</span><span class="p">)</span></div>

<div class="viewcode-block" id="BoltzmannPlot.bplot_constants"><a class="viewcode-back" href="../../fulcheranalyzer.coronalmodel.html#fulcheranalyzer.coronalmodel.BoltzmannPlot.bplot_constants">[docs]</a>    <span class="k">def</span> <span class="nf">bplot_constants</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculated 2J+1, g_as, and Franck-Condon vectors </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># D2</span>
        <span class="c1"># vector of  2J + 1, same for D2 and H2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">v2jp1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">J</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span> <span class="k">for</span> <span class="n">J</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inte</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])])[</span>
            <span class="p">:,</span> <span class="kc">None</span>
        <span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">isotop</span> <span class="o">==</span> <span class="s2">&quot;d&quot;</span><span class="p">:</span>
            <span class="c1"># vector g_as</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">vg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
                <span class="p">[</span><span class="mi">6</span> <span class="o">-</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">mod</span><span class="p">((</span><span class="n">J</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span> <span class="k">for</span> <span class="n">J</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inte</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])]</span>
            <span class="p">)[:,</span> <span class="kc">None</span><span class="p">]</span>
            <span class="c1"># Franck-Condon factors</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">2.3387e7</span><span class="p">,</span> <span class="mf">1.8841e7</span><span class="p">,</span> <span class="mf">1.4795e7</span><span class="p">,</span> <span class="mf">1.1276e7</span><span class="p">])</span>

            <span class="c1"># So I&#39;m just broadcasting Aev for electronic levels into AevJ for ro-vib with same vals</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">AevJ</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
                <span class="p">[[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Aev</span><span class="p">]</span> <span class="k">for</span> <span class="n">J</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inte</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])]</span>
            <span class="p">)</span>
        <span class="c1"># H2</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">isotop</span> <span class="o">==</span> <span class="s2">&quot;h&quot;</span><span class="p">:</span>
            <span class="c1"># vector g_as</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">vg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
                <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">mod</span><span class="p">((</span><span class="n">J</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span> <span class="k">for</span> <span class="n">J</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inte</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])]</span>
            <span class="p">)[:,</span> <span class="kc">None</span><span class="p">]</span>
            <span class="c1"># Franck-Condon factors (Relative?)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.93016</span><span class="p">,</span> <span class="mf">0.79701</span><span class="p">,</span> <span class="mf">0.67139</span><span class="p">])</span>
            <span class="c1"># For H2 self.Aev[:-1] because Hydrogen discharge had only v = 0,1,2.</span>
            <span class="c1"># TODO: automatically correct shape if intensities include values up to v = 3.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">AevJ</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
                <span class="p">[[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Aev</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span> <span class="k">for</span> <span class="n">J</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inte</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])]</span>
            <span class="p">)</span></div>

<div class="viewcode-block" id="BoltzmannPlot.calculate_boltzmann"><a class="viewcode-back" href="../../fulcheranalyzer.coronalmodel.html#fulcheranalyzer.coronalmodel.BoltzmannPlot.calculate_boltzmann">[docs]</a>    <span class="k">def</span> <span class="nf">calculate_boltzmann</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; </span>
<span class="sd">        Calculate population from intensity.</span>
<span class="sd">        nd: population of the upper state d3</span>
<span class="sd">        nd_bol: nd/(2J+1)/g_as for Boltzmann plot</span>
<span class="sd">        nd_rel: nd_bol/nd_bol[0][0]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># nd = I*lambda / (hc) / A, so formula before is true up to a constant hc</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inte</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">wl</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">AevJ</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nd_bol</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inte</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">wl</span> <span class="o">**</span> <span class="mi">4</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">v2jp1</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">vg</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">fc</span>
        <span class="n">norm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nd_bol</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nd_rel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nd_bol</span> <span class="o">/</span> <span class="n">norm</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mask</span> <span class="o">=</span> <span class="o">~</span><span class="n">pd</span><span class="o">.</span><span class="n">isna</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nd_rel</span><span class="p">)</span>
        <span class="n">m</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mask</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">qnames</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
            <span class="p">[[</span><span class="sa">f</span><span class="s2">&quot;Q</span><span class="si">{</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">(</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">)&quot;</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">m</span><span class="p">[</span><span class="n">i</span><span class="p">])]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">m</span><span class="p">]</span>
        <span class="p">)</span><span class="o">.</span><span class="n">T</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">nd_err</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">interr</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">wl</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">AevJ</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nd_bol_err</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nd_err</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">v2jp1</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">vg</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">fc</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">relerr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nd_err</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">nd</span></div>

<div class="viewcode-block" id="BoltzmannPlot.plot_boltzmannn"><a class="viewcode-back" href="../../fulcheranalyzer.coronalmodel.html#fulcheranalyzer.coronalmodel.BoltzmannPlot.plot_boltzmannn">[docs]</a>    <span class="k">def</span> <span class="nf">plot_boltzmannn</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; </span>
<span class="sd">        Plto Boltzmann plot </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

        <span class="n">plot_n_all_v</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nd_rel</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ed</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">mask</span><span class="p">],</span> <span class="n">log</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;E, ev&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;$n/(2J+1)/g_</span><span class="si">{as}</span><span class="s2">$&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">yscale</span><span class="p">(</span><span class="s2">&quot;log&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="BoltzmannPlot.prep_fit"><a class="viewcode-back" href="../../fulcheranalyzer.coronalmodel.html#fulcheranalyzer.coronalmodel.BoltzmannPlot.prep_fit">[docs]</a>    <span class="k">def</span> <span class="nf">prep_fit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; </span>
<span class="sd">        prep 2-temperature fit for all vibrational q.n. at the same time </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># initial guess</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">param</span> <span class="o">=</span> <span class="p">[</span><span class="mf">6.9e-1</span><span class="p">,</span> <span class="mf">6.0e-1</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="mi">1700</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span>
            <span class="mi">1</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inte</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="p">]</span>
        <span class="c1"># bounds</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bounds</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">[</span><span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">1000</span><span class="p">]</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="mf">0.1</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inte</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])),</span>
            <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">800</span><span class="p">,</span> <span class="mi">3000</span><span class="p">]</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="mf">1.5</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inte</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])),</span>
        <span class="p">]</span></div>

<div class="viewcode-block" id="BoltzmannPlot.plot_fit"><a class="viewcode-back" href="../../fulcheranalyzer.coronalmodel.html#fulcheranalyzer.coronalmodel.BoltzmannPlot.plot_fit">[docs]</a>    <span class="k">def</span> <span class="nf">plot_fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">init</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; </span>
<span class="sd">        plot nd_rel and resuls for initial guess </span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        init: bool</span>
<span class="sd">            True - use initial data, False - use fitting result.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

        <span class="k">if</span> <span class="n">init</span><span class="p">:</span>
            <span class="n">param</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">param</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">param</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">popt</span>

        <span class="n">ns</span> <span class="o">=</span> <span class="n">two_t_all_v</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Ed</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">mask</span><span class="p">],</span> <span class="o">*</span><span class="n">param</span><span class="p">)</span>
        <span class="n">nd</span> <span class="o">=</span> <span class="n">flatdf</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nd_rel</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">nd</span><span class="p">),</span> <span class="s2">&quot;ks-&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ns</span><span class="p">,</span> <span class="s2">&quot;C1o&quot;</span><span class="p">)</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">1.05</span><span class="p">,</span> <span class="n">fittext</span><span class="p">(</span><span class="n">param</span><span class="p">),</span> <span class="n">transform</span><span class="o">=</span><span class="n">ax</span><span class="o">.</span><span class="n">transAxes</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;E, ev&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;$\ln{\left( n/(2J+1)/g_</span><span class="si">{as}</span><span class="se">\\</span><span class="s2">right)}$, a.u.&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="BoltzmannPlot.print_fit_result"><a class="viewcode-back" href="../../fulcheranalyzer.coronalmodel.html#fulcheranalyzer.coronalmodel.BoltzmannPlot.print_fit_result">[docs]</a>    <span class="k">def</span> <span class="nf">print_fit_result</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Print fit result </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">err</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">err</span>
        <span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;alpha&quot;</span><span class="p">,</span> <span class="s2">&quot;beta&quot;</span><span class="p">,</span> <span class="s2">&quot;Trot1&quot;</span><span class="p">,</span> <span class="s2">&quot;Trot2&quot;</span><span class="p">]</span>
        <span class="n">pr</span> <span class="o">=</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
        <span class="nb">print</span><span class="p">(</span>
            <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="p">[</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">n</span><span class="si">}</span><span class="s2"> = </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">popt</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">:</span><span class="s2">.</span><span class="si">{</span><span class="n">pr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="s2">f</span><span class="si">}</span><span class="s2"> +- </span><span class="si">{</span><span class="n">err</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">:</span><span class="s2">.</span><span class="si">{</span><span class="n">pr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="s2">f</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">names</span><span class="p">)</span>
                <span class="p">]</span>
            <span class="p">)</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="BoltzmannPlot.fit_boltzmann"><a class="viewcode-back" href="../../fulcheranalyzer.coronalmodel.html#fulcheranalyzer.coronalmodel.BoltzmannPlot.fit_boltzmann">[docs]</a>    <span class="k">def</span> <span class="nf">fit_boltzmann</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Fit boltzmann distribution with 2-temp and </span>
<span class="sd">        all vibrational quantum numbers at onece.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">scipy.optimize</span> <span class="kn">import</span> <span class="n">curve_fit</span>

        <span class="c1"># make sure that temperature ratios are normalized</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mol</span><span class="o">.</span><span class="n">calculate_tfrac</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inte</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">norm</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">popt</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pcov</span> <span class="o">=</span> <span class="n">curve_fit</span><span class="p">(</span>
            <span class="n">two_t_all_v</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Ed</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">mask</span><span class="p">],</span>
            <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">flatdf</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nd_rel</span><span class="p">)),</span>
            <span class="n">p0</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">param</span><span class="p">,</span>
            <span class="n">bounds</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">bounds</span><span class="p">,</span>
            <span class="n">sigma</span><span class="o">=</span><span class="n">flatdf</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">relerr</span><span class="p">),</span>
            <span class="n">absolute_sigma</span><span class="o">=</span><span class="n">ABSOLUTESIGMA</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">calc_nd_synth</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">trot1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">popt</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trot2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">popt</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">popt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">beta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">popt</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">err</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pcov</span><span class="p">))</span></div>

<div class="viewcode-block" id="BoltzmannPlot.calc_nd_synth"><a class="viewcode-back" href="../../fulcheranalyzer.coronalmodel.html#fulcheranalyzer.coronalmodel.BoltzmannPlot.calc_nd_synth">[docs]</a>    <span class="k">def</span> <span class="nf">calc_nd_synth</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Afer successfull boltzmann plot fit, calculate synthetic ro-vib population.</span>
<span class="sd">        This will &quot;fill&quot; the missing lines intensities.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nd_bol_synth</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">two_t_all_v</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Ed</span><span class="p">,</span> <span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">popt</span><span class="p">,</span> <span class="n">melt</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nd_synth</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nd_bol_synth</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">v2jp1</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">vg</span></div>

<div class="viewcode-block" id="BoltzmannPlot.plot_fit_nice"><a class="viewcode-back" href="../../fulcheranalyzer.coronalmodel.html#fulcheranalyzer.coronalmodel.BoltzmannPlot.plot_fit_nice">[docs]</a>    <span class="k">def</span> <span class="nf">plot_fit_nice</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        plot fit result </span>
<span class="sd">        plot Boltzamnn distribution with preformated output using plot_n_all</span>
<span class="sd">        data: nd_rel(Ed) here rel for relative, defined up to a multiplier constant</span>
<span class="sd">        fit: ns(Ed), s for synthetic</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

        <span class="n">ns</span> <span class="o">=</span> <span class="n">two_t_all_v</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Ed</span><span class="p">,</span> <span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">popt</span><span class="p">,</span> <span class="n">melt</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">plot_n_all_v</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">ns</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ed</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">nomarker</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">set_prop_cycle</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
        <span class="n">plot_n_all_v</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nd_rel</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ed</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">noline</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">yscale</span><span class="p">(</span><span class="s2">&quot;log&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;E, ev&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;$n/(2J+1)/g_</span><span class="si">{as}</span><span class="s2">$, a.u.&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="BoltzmannPlot.calc_nd_const"><a class="viewcode-back" href="../../fulcheranalyzer.coronalmodel.html#fulcheranalyzer.coronalmodel.BoltzmannPlot.calc_nd_const">[docs]</a>    <span class="k">def</span> <span class="nf">calc_nd_const</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; </span>
<span class="sd">        Calculate constant for synthetic nd_synth to match with nd</span>
<span class="sd">        c_nd - multiplier constant for synthetic nd</span>
<span class="sd">        c_nd_err - error for these constants for each vibrational q.n.</span>
<span class="sd">        nd_sc - nd synthetic (s) constant (c) - synthetic upper statat population with correct constant</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">scipy.optimize</span> <span class="kn">import</span> <span class="n">curve_fit</span>

        <span class="n">res</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">curve_fit</span><span class="p">(</span>
                <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">c</span><span class="p">:</span> <span class="n">c</span> <span class="o">*</span> <span class="n">x</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">nd_synth</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">mask</span><span class="p">][</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">dropna</span><span class="p">(),</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">nd</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">dropna</span><span class="p">(),</span>
                <span class="mf">1e-7</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nd</span>
        <span class="p">]</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">res</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">c_nd</span> <span class="o">=</span> <span class="n">res</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">c_nd_er</span> <span class="o">=</span> <span class="n">res</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nd_sc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nd_synth</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">c_nd</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">nd_vibrofit</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nd_sc</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">nd_sc</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span><span class="o">.</span><span class="n">values</span></div>

<div class="viewcode-block" id="BoltzmannPlot.plot_nd"><a class="viewcode-back" href="../../fulcheranalyzer.coronalmodel.html#fulcheranalyzer.coronalmodel.BoltzmannPlot.plot_nd">[docs]</a>    <span class="k">def</span> <span class="nf">plot_nd</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">v</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot nd experimental and synthetic</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nd</span><span class="p">[</span><span class="n">v</span><span class="p">],</span> <span class="s2">&quot;o&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nd_synth</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">c_nd</span><span class="p">[</span><span class="n">v</span><span class="p">],</span> <span class="s2">&quot;kx&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">locator_params</span><span class="p">(</span><span class="n">nbins</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">14</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span></div>

<div class="viewcode-block" id="BoltzmannPlot.calc_all_rot_temp"><a class="viewcode-back" href="../../fulcheranalyzer.coronalmodel.html#fulcheranalyzer.coronalmodel.BoltzmannPlot.calc_all_rot_temp">[docs]</a>    <span class="k">def</span> <span class="nf">calc_all_rot_temp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate Trot for d- and X-states for all v</span>
<span class="sd">        put them into DataFrame</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mol</span><span class="o">.</span><span class="n">calculate_tfrac</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nd</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">norm</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">frac</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mol</span><span class="o">.</span><span class="n">frac</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">isotop</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        <span class="n">fr</span> <span class="o">=</span> <span class="n">frac</span> <span class="o">/</span> <span class="n">frac</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">trotd</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
            <span class="p">[</span><span class="n">fr</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">trot1</span><span class="p">,</span> <span class="n">fr</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">err</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">fr</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">trot2</span><span class="p">,</span> <span class="n">fr</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">err</span><span class="p">[</span><span class="mi">3</span><span class="p">]],</span>
            <span class="p">[</span><span class="s2">&quot;d Trot1&quot;</span><span class="p">,</span> <span class="s2">&quot;d er1&quot;</span><span class="p">,</span> <span class="s2">&quot;d Trot2&quot;</span><span class="p">,</span> <span class="s2">&quot;d er2&quot;</span><span class="p">],</span>
        <span class="p">)</span><span class="o">.</span><span class="n">T</span>

        <span class="n">fr</span> <span class="o">=</span> <span class="n">frac</span>
        <span class="n">trotx</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
            <span class="p">[</span><span class="n">fr</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">trot1</span><span class="p">,</span> <span class="n">fr</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">err</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">fr</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">trot2</span><span class="p">,</span> <span class="n">fr</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">err</span><span class="p">[</span><span class="mi">3</span><span class="p">]],</span>
            <span class="p">[</span><span class="s2">&quot;X Trot1&quot;</span><span class="p">,</span> <span class="s2">&quot;X er1&quot;</span><span class="p">,</span> <span class="s2">&quot;X Trot2&quot;</span><span class="p">,</span> <span class="s2">&quot;X er2&quot;</span><span class="p">],</span>
        <span class="p">)</span><span class="o">.</span><span class="n">T</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trotall</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">trotd</span><span class="p">,</span> <span class="n">trotx</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span></div>

<div class="viewcode-block" id="BoltzmannPlot.autofit"><a class="viewcode-back" href="../../fulcheranalyzer.coronalmodel.html#fulcheranalyzer.coronalmodel.BoltzmannPlot.autofit">[docs]</a>    <span class="k">def</span> <span class="nf">autofit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; </span>
<span class="sd">        A shortcut function to run required fits with default parameters </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fit_boltzmann</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">calc_nd_const</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">calc_all_rot_temp</span><span class="p">()</span></div>

<div class="viewcode-block" id="BoltzmannPlot.set_style"><a class="viewcode-back" href="../../fulcheranalyzer.coronalmodel.html#fulcheranalyzer.coronalmodel.BoltzmannPlot.set_style">[docs]</a>    <span class="k">def</span> <span class="nf">set_style</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">6</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Define plot sytles for &quot;standard&quot; plot outputs.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">style_popd</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">{</span>
                <span class="s2">&quot;capsize&quot;</span><span class="p">:</span> <span class="n">size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
                <span class="s2">&quot;fmt&quot;</span><span class="p">:</span> <span class="n">i</span><span class="p">,</span>
                <span class="s2">&quot;mec&quot;</span><span class="p">:</span> <span class="n">m</span><span class="p">,</span>
                <span class="s2">&quot;mfc&quot;</span><span class="p">:</span> <span class="n">j</span><span class="p">,</span>
                <span class="s2">&quot;color&quot;</span><span class="p">:</span> <span class="s2">&quot;k&quot;</span><span class="p">,</span>
                <span class="s2">&quot;mec&quot;</span><span class="p">:</span> <span class="n">m</span><span class="p">,</span>
                <span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;(v&#39;-v&#39;&#39;) = (</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">,</span>
                <span class="s2">&quot;ms&quot;</span><span class="p">:</span> <span class="n">size</span><span class="p">,</span>
                <span class="s2">&quot;mew&quot;</span><span class="p">:</span> <span class="n">l</span><span class="p">,</span>
                <span class="s2">&quot;lw&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
            <span class="p">}</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span>
                <span class="p">[</span><span class="s2">&quot;o&quot;</span><span class="p">,</span> <span class="s2">&quot;o&quot;</span><span class="p">,</span> <span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;s&quot;</span><span class="p">],</span>
                <span class="p">[</span><span class="s2">&quot;k&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="s2">&quot;k&quot;</span><span class="p">,</span> <span class="s2">&quot;dimgray&quot;</span><span class="p">],</span>
                <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span>
                <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,],</span>
                <span class="p">[</span><span class="s2">&quot;k&quot;</span><span class="p">,</span> <span class="s2">&quot;k&quot;</span><span class="p">,</span> <span class="s2">&quot;k&quot;</span><span class="p">,</span> <span class="s2">&quot;k&quot;</span><span class="p">],</span>
            <span class="p">)</span>
        <span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">style_popd_color</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">{</span>
                <span class="s2">&quot;capsize&quot;</span><span class="p">:</span> <span class="n">size</span><span class="p">,</span>
                <span class="s2">&quot;elinewidth&quot;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">,</span>
                <span class="s2">&quot;fmt&quot;</span><span class="p">:</span> <span class="n">i</span><span class="p">,</span>
                <span class="s2">&quot;mec&quot;</span><span class="p">:</span> <span class="n">m</span><span class="p">,</span>
                <span class="s2">&quot;mfc&quot;</span><span class="p">:</span> <span class="n">m</span><span class="p">,</span>
                <span class="s2">&quot;color&quot;</span><span class="p">:</span> <span class="n">m</span><span class="p">,</span>
                <span class="s2">&quot;mec&quot;</span><span class="p">:</span> <span class="n">m</span><span class="p">,</span>
                <span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;(v&#39;-v&#39;&#39;) = (</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">,</span>
                <span class="s2">&quot;ms&quot;</span><span class="p">:</span> <span class="n">size</span><span class="p">,</span>
                <span class="s2">&quot;mew&quot;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">,</span>
                <span class="s2">&quot;lw&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
            <span class="p">}</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span>
                <span class="p">[</span><span class="s2">&quot;s&quot;</span><span class="p">,</span> <span class="s2">&quot;o&quot;</span><span class="p">,</span> <span class="s2">&quot;d&quot;</span><span class="p">,</span> <span class="s2">&quot;x&quot;</span><span class="p">],</span>
                <span class="p">[</span><span class="s2">&quot;k&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="s2">&quot;k&quot;</span><span class="p">,</span> <span class="s2">&quot;dimgray&quot;</span><span class="p">],</span>
                <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span>
                <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;C</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">)],</span>
            <span class="p">)</span>
        <span class="p">]</span></div>

<div class="viewcode-block" id="BoltzmannPlot.plot_popd_paper"><a class="viewcode-back" href="../../fulcheranalyzer.coronalmodel.html#fulcheranalyzer.coronalmodel.BoltzmannPlot.plot_popd_paper">[docs]</a>    <span class="k">def</span> <span class="nf">plot_popd_paper</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stylename</span><span class="o">=</span><span class="s2">&quot;bw&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">11</span><span class="p">,</span> <span class="n">ms</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot d-state population with errors and fit results </span>
<span class="sd">        fontsize = 11, image width = 8cm (for WORD document)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">pyplot</span> <span class="k">as</span> <span class="n">plt</span>

        <span class="n">relerr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">relerr</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_style</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="n">ms</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">stylename</span> <span class="o">==</span> <span class="s2">&quot;color&quot;</span><span class="p">:</span>
            <span class="n">style</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">style_popd_color</span>
        <span class="k">if</span> <span class="n">stylename</span> <span class="o">==</span> <span class="s2">&quot;bw&quot;</span><span class="p">:</span>
            <span class="n">style</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">style_popd</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nd</span><span class="p">:</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">flatdf</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Ed</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">mask</span><span class="p">][</span><span class="n">i</span><span class="p">])</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">flatdf</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nd_rel</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="n">yerr</span> <span class="o">=</span> <span class="n">flatdf</span><span class="p">(</span><span class="n">relerr</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">*</span> <span class="n">y</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">yerr</span><span class="o">=</span><span class="n">yerr</span><span class="p">,</span> <span class="o">**</span><span class="n">style</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Ed</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">nd_bol_synth</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">style</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;mec&quot;</span><span class="p">])</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">([],</span> <span class="p">[],</span> <span class="s2">&quot;k:&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;fitted&quot;</span><span class="p">)</span>

        <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>
        <span class="n">handles</span><span class="p">,</span> <span class="n">labels</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_legend_handles_labels</span><span class="p">()</span>
        <span class="n">handles</span> <span class="o">=</span> <span class="n">handles</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">+</span> <span class="p">[</span><span class="n">handles</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="n">labels</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">+</span> <span class="p">[</span><span class="n">labels</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">handles</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span> <span class="o">-</span> <span class="mf">4.5</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Ed</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mf">0.98</span><span class="p">,</span>
            <span class="p">((</span><span class="n">flatdf</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">relerr</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">flatdf</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nd_rel</span><span class="p">[</span><span class="mi">0</span><span class="p">]))[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mf">0.02</span><span class="p">,</span>
            <span class="sa">f</span><span class="s2">&quot;N&#39;=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">nd</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="n">ha</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span>
            <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span> <span class="o">-</span> <span class="mi">2</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">yscale</span><span class="p">(</span><span class="s2">&quot;log&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Rotational Energy [eV]&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span>
            <span class="s2">&quot;$\mathdefault{\mathrm{</span><span class="se">\\</span><span class="s2">frac{ n_{dv&#39;N&#39;}}{(2N&#39;+1)g^{N&#39;}_</span><span class="si">{as}</span><span class="s2">}}}$ [a.u.]&quot;</span><span class="p">,</span>
            <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="mf">0.01</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="o">-</span><span class="mf">0.025</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span><span class="o">.</span><span class="n">set_size_inches</span><span class="p">(</span><span class="n">figsize</span><span class="p">(</span><span class="mi">8</span><span class="p">))</span></div>

<div class="viewcode-block" id="BoltzmannPlot.about_var"><a class="viewcode-back" href="../../fulcheranalyzer.coronalmodel.html#fulcheranalyzer.coronalmodel.BoltzmannPlot.about_var">[docs]</a>    <span class="k">def</span> <span class="nf">about_var</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; </span>
<span class="sd">        Print info about variables.</span>
<span class="sd">        TODO: improve names to reduce confusion</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">s</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;nd: population of the upper state d3</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;nd_bol: nd/(2J+1)/g_as for Boltzmann plot</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;nd_rel: nd_bol/nd_bol[0][0]</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;nd_bol_synth = np.exp(two_t_all_v(Ed, *popt, melt=False))</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;nd_synth = nd_bol_synth * v2jp1 * vg</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;nd_sc: nd synthetic (s) constant (c) - synthetic upper state population with correct constant</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;nd_vibrofit = (nd_sc.sum() / nd_sc.sum().sum()).values - synthetic vibro population</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="n">s</span><span class="p">)</span></div></div>


<span class="c1"># ==================================================</span>
<span class="c1">#</span>
<span class="c1">#  Coronal Model useful functions</span>
<span class="c1">#</span>
<span class="c1"># ==================================================</span>


<div class="viewcode-block" id="CoronaModel"><a class="viewcode-back" href="../../fulcheranalyzer.coronalmodel.html#fulcheranalyzer.coronalmodel.CoronaModel">[docs]</a><span class="k">class</span> <span class="nc">CoronaModel</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot; </span>
<span class="sd">    Coronal Model class </span>
<span class="sd">    Based on the Ishihara-s code.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    isotop: string</span>
<span class="sd">         &#39;d&#39; or &#39;h&#39; </span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bp</span><span class="p">:</span> <span class="n">BoltzmannPlot</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;Coronal Model for H and D&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bp</span> <span class="o">=</span> <span class="n">bp</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">isotop</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bp</span><span class="o">.</span><span class="n">isotop</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prep_constants</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prep_style</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">prep_corona_fit</span><span class="p">(</span><span class="n">load</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Load constants from MolecularConstants, don&#39;t keep them here.</span>
        <span class="c1"># self.acoeff()</span>
        <span class="c1"># self.load_constants()</span>

<div class="viewcode-block" id="CoronaModel.prep_style"><a class="viewcode-back" href="../../fulcheranalyzer.coronalmodel.html#fulcheranalyzer.coronalmodel.CoronaModel.prep_style">[docs]</a>    <span class="k">def</span> <span class="nf">prep_style</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ms</span><span class="o">=</span><span class="mi">8</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; </span>
<span class="sd">        Prepare standard plot styles </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">style_coronaplot</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">{</span>
                <span class="s2">&quot;capsize&quot;</span><span class="p">:</span> <span class="mf">0.8</span> <span class="o">*</span> <span class="n">ms</span><span class="p">,</span>
                <span class="s2">&quot;capthick&quot;</span><span class="p">:</span> <span class="mf">0.4</span><span class="p">,</span>
                <span class="s2">&quot;elinewidth&quot;</span><span class="p">:</span> <span class="mf">0.4</span><span class="p">,</span>
                <span class="s2">&quot;fmt&quot;</span><span class="p">:</span> <span class="n">i</span><span class="p">,</span>
                <span class="s2">&quot;ecolor&quot;</span><span class="p">:</span> <span class="n">j</span><span class="p">,</span>
                <span class="s2">&quot;markeredgecolor&quot;</span><span class="p">:</span> <span class="n">j</span><span class="p">,</span>
                <span class="s2">&quot;color&quot;</span><span class="p">:</span> <span class="n">j</span><span class="p">,</span>
                <span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="n">k</span><span class="p">,</span>
                <span class="s2">&quot;ms&quot;</span><span class="p">:</span> <span class="n">l</span><span class="p">,</span>
                <span class="s2">&quot;lw&quot;</span><span class="p">:</span> <span class="mf">0.6</span><span class="p">,</span>
            <span class="p">}</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span>
                <span class="p">[</span><span class="s2">&quot;o-.&quot;</span><span class="p">,</span> <span class="s2">&quot;s-.&quot;</span><span class="p">],</span>
                <span class="p">[</span><span class="s2">&quot;k&quot;</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">],</span>
                <span class="p">[</span><span class="s2">&quot;experiment&quot;</span><span class="p">,</span> <span class="s2">&quot;reconstructed&quot;</span><span class="p">],</span>
                <span class="p">[</span><span class="n">ms</span><span class="p">,</span> <span class="mf">0.7</span> <span class="o">*</span> <span class="n">ms</span><span class="p">],</span>
            <span class="p">)</span>
        <span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">style_rovib</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">{</span>
                <span class="s2">&quot;lw&quot;</span><span class="p">:</span> <span class="mf">0.8</span><span class="p">,</span>
                <span class="s2">&quot;marker&quot;</span><span class="p">:</span> <span class="n">i</span><span class="p">,</span>
                <span class="s2">&quot;mfc&quot;</span><span class="p">:</span> <span class="n">j</span><span class="p">,</span>
                <span class="s2">&quot;c&quot;</span><span class="p">:</span> <span class="s2">&quot;k&quot;</span><span class="p">,</span>
                <span class="s2">&quot;ls&quot;</span><span class="p">:</span> <span class="s2">&quot;-.&quot;</span><span class="p">,</span>
                <span class="s2">&quot;ms&quot;</span><span class="p">:</span> <span class="n">ms</span><span class="p">,</span>
                <span class="s2">&quot;mew&quot;</span><span class="p">:</span> <span class="n">k</span><span class="p">,</span>
                <span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;v=</span><span class="si">{</span><span class="n">s</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="p">}</span>
            <span class="k">for</span> <span class="n">s</span><span class="p">,</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span>
                <span class="nb">zip</span><span class="p">(</span>
                    <span class="p">[</span><span class="s2">&quot;o&quot;</span><span class="p">,</span> <span class="s2">&quot;o&quot;</span><span class="p">,</span> <span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;s&quot;</span><span class="p">],</span>
                    <span class="p">[</span><span class="s2">&quot;k&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="s2">&quot;k&quot;</span><span class="p">,</span> <span class="s2">&quot;k&quot;</span><span class="p">],</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span> <span class="o">*</span> <span class="mf">0.5</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="p">]</span></div>

<div class="viewcode-block" id="CoronaModel.prep_constants"><a class="viewcode-back" href="../../fulcheranalyzer.coronalmodel.html#fulcheranalyzer.coronalmodel.CoronaModel.prep_constants">[docs]</a>    <span class="k">def</span> <span class="nf">prep_constants</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Prepare the nessecary constanst</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">mol</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bp</span><span class="o">.</span><span class="n">mol</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mol</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bp</span><span class="o">.</span><span class="n">mol</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">isotop</span> <span class="o">==</span> <span class="s2">&quot;d&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">A</span> <span class="o">=</span> <span class="n">mol</span><span class="o">.</span><span class="n">AD</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Asum</span> <span class="o">=</span> <span class="n">mol</span><span class="o">.</span><span class="n">ADsum</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">E_vib</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ee_vib</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fcf</span> <span class="o">=</span> <span class="n">mol</span><span class="o">.</span><span class="n">corona_constants_d</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">isotop</span> <span class="o">==</span> <span class="s2">&quot;h&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">A</span> <span class="o">=</span> <span class="n">mol</span><span class="o">.</span><span class="n">AH</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Asum</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mol</span><span class="o">.</span><span class="n">AHsum</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">E_vib</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ee_vib</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fcf</span> <span class="o">=</span> <span class="n">mol</span><span class="o">.</span><span class="n">corona_constants_h</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">v_range_f_vibro</span> <span class="o">=</span> <span class="p">[</span>
            <span class="mi">5</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bp</span><span class="o">.</span><span class="n">nd</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
        <span class="p">]</span>  <span class="c1"># [vx_range, vd_range] for fit_vibro()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">calc_rtp</span><span class="p">()</span></div>

<div class="viewcode-block" id="CoronaModel.calculate_e_cross"><a class="viewcode-back" href="../../fulcheranalyzer.coronalmodel.html#fulcheranalyzer.coronalmodel.CoronaModel.calculate_e_cross">[docs]</a>    <span class="k">def</span> <span class="nf">calculate_e_cross</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Te</span><span class="o">=</span><span class="mi">15</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; </span>
<span class="sd">        Dublicate of self.ccs_formula().</span>
<span class="sd">        For fitting vibro population, which is calculated from simulated rot. pop. and summed up.</span>

<span class="sd">        Calculate electron impact crossections for given electron temperature Te [eV]</span>
<span class="sd">        Here Ee_vib is excited state vibrational energy,the d-state. </span>
<span class="sd">        E_vib is X-state vibrational energy.</span>
<span class="sd">        Matrix shape is same as Franck-Condon data shape.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        Te: float</span>
<span class="sd">            electron temperature for Coronal Model</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">scipy.constants</span> <span class="kn">import</span> <span class="n">Boltzmann</span><span class="p">,</span> <span class="n">elementary_charge</span>

        <span class="n">kb</span> <span class="o">=</span> <span class="n">Boltzmann</span> <span class="o">/</span> <span class="n">elementary_charge</span>
        <span class="n">Te</span> <span class="o">=</span> <span class="n">Te</span> <span class="o">/</span> <span class="n">kb</span>  <span class="c1"># Convert Te from [eV] to [K]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">ccs</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="p">[</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span>
                        <span class="o">-</span><span class="p">(</span>
                            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Ee_vib</span><span class="p">[</span><span class="n">vd</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ee_vib</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                            <span class="o">-</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">E_vib</span><span class="p">[</span><span class="n">vX</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">E_vib</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                        <span class="p">)</span>
                        <span class="o">/</span> <span class="p">(</span><span class="n">kb</span> <span class="o">*</span> <span class="n">Te</span><span class="p">)</span>
                    <span class="p">)</span>
                    <span class="k">for</span> <span class="n">vd</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fcf</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]))</span>
                <span class="p">]</span>
                <span class="k">for</span> <span class="n">vX</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fcf</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]))</span>
            <span class="p">]</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="CoronaModel.f_vibro"><a class="viewcode-back" href="../../fulcheranalyzer.coronalmodel.html#fulcheranalyzer.coronalmodel.CoronaModel.f_vibro">[docs]</a>    <span class="k">def</span> <span class="nf">f_vibro</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">T_vib</span><span class="p">,</span> <span class="n">fit</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; </span>
<span class="sd">        Function for fitting vibrational population. </span>
<span class="sd">        This is Coronal Model, used by Ishihara </span>
<span class="sd">        (but population is summed by rotational quantum number).</span>
<span class="sd">        Second variable &quot;_&quot; is for independent variable, </span>
<span class="sd">        required by scipy.optimize.curve_fit. In this case it is not needed.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        T_vib: float</span>
<span class="sd">            vibrational temperature</span>
<span class="sd">        fit: bool</span>
<span class="sd">            True - return normalized population, False - return nv</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">scipy.constants</span> <span class="kn">import</span> <span class="n">Boltzmann</span><span class="p">,</span> <span class="n">elementary_charge</span>

        <span class="n">kb</span> <span class="o">=</span> <span class="n">Boltzmann</span> <span class="o">/</span> <span class="n">elementary_charge</span>
        <span class="n">vx_range</span><span class="p">,</span> <span class="n">vd_range</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">v_range_f_vibro</span>

        <span class="n">ccs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ccs</span><span class="o">.</span><span class="n">values</span>
        <span class="n">nv</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="p">[</span>
                    <span class="n">ccs</span><span class="p">[</span><span class="n">vx</span><span class="p">,</span> <span class="n">vd</span><span class="p">]</span>
                    <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">fcf</span><span class="p">[</span><span class="n">vx</span><span class="p">,</span> <span class="n">vd</span><span class="p">]</span>
                    <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">E_vib</span><span class="p">[</span><span class="n">vx</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">E_vib</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="n">kb</span> <span class="o">*</span> <span class="n">T_vib</span><span class="p">))</span>
                    <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">Asum</span><span class="p">[</span><span class="n">vd</span><span class="p">]</span>
                    <span class="k">for</span> <span class="n">vd</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">vd_range</span><span class="p">)</span>
                <span class="p">]</span>
                <span class="k">for</span> <span class="n">vx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">vx_range</span><span class="p">)</span>
            <span class="p">]</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">fit</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">nv</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">nv</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="n">nv</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span><span class="o">.</span><span class="n">values</span></div>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    :math:`n_{dv&#39;}\sum{A^{dv&#39;}_{av&#39;&#39;}} \propto \sum_{v=0}^{vmax} R_{Xv}^{dv&#39;}</span>
<span class="sd">         \exp{\left( -\frac{E_{vib}^{X}(v)}{kT_{vib}^{X}} \right)}`</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="CoronaModel.fit_vibro_ishi"><a class="viewcode-back" href="../../fulcheranalyzer.coronalmodel.html#fulcheranalyzer.coronalmodel.CoronaModel.fit_vibro_ishi">[docs]</a>    <span class="k">def</span> <span class="nf">fit_vibro_ishi</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; </span>
<span class="sd">        Ishihara-s vibro fit</span>
<span class="sd">        Fit vibrational population, ignoring rotational distribuiton to get Tvib.</span>
<span class="sd">        See formula (4.5) from Ishihara-s Master thesis, page 36. There R-coefficient </span>
<span class="sd">        is not rotationally resolved and hence does not include the branching ratio.</span>

<span class="sd">        :math:`n_{dv\&#39;} \sum{A^{dv\&#39;}_{av\&#39;\&#39;}} \propto \sum_{v=0}^{vmax} R_{Xv}^{dv\&#39;}</span>
<span class="sd">        \exp{\left( -\\frac{E_{vib}^{X}(v)}{kT_{vib}^{X}} \\right)}`</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">scipy.optimize</span> <span class="kn">import</span> <span class="n">curve_fit</span>

        <span class="n">tvib</span><span class="p">,</span> <span class="n">cov</span> <span class="o">=</span> <span class="n">curve_fit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">f_vibro</span><span class="p">,</span> <span class="p">[],</span> <span class="bp">self</span><span class="o">.</span><span class="n">bp</span><span class="o">.</span><span class="n">nd_vibrofit</span><span class="p">,</span> <span class="mi">10000</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tvib</span> <span class="o">=</span> <span class="n">tvib</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tvib_cov</span> <span class="o">=</span> <span class="n">cov</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tvib_err</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tvib_cov</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Tvib = </span><span class="si">{</span><span class="n">tvib</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">:</span><span class="s2">.0f</span><span class="si">}</span><span class="s2"> +- </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">tvib_err</span><span class="si">:</span><span class="s2">.0f</span><span class="si">}</span><span class="s2"> K&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="CoronaModel.plot_fit_ishi"><a class="viewcode-back" href="../../fulcheranalyzer.coronalmodel.html#fulcheranalyzer.coronalmodel.CoronaModel.plot_fit_ishi">[docs]</a>    <span class="k">def</span> <span class="nf">plot_fit_ishi</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kws</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; </span>
<span class="sd">        &quot;Nice&quot; plot of the vibro fit and &#39;gauge&#39; for Ishihara-s fit </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

        <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">set_size_inches</span><span class="p">([</span><span class="mi">7</span><span class="p">,</span> <span class="mi">6</span><span class="p">])</span>

        <span class="n">tvs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">31</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1000</span>
        <span class="n">colors</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">jet</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">tvs</span><span class="p">)))</span>
        <span class="n">gls</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">tvs</span><span class="p">):</span>
            <span class="n">nv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">f_vibro</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
            <span class="p">(</span><span class="n">ll</span><span class="p">,)</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">nv</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="s2">&quot;.-&quot;</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">colors</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">t</span><span class="o">//</span><span class="mi">1000</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">gls</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ll</span><span class="p">,)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">tvib</span> <span class="o">=</span> <span class="n">kws</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;tvib&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tvib</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">tvib</span> <span class="o">=</span> <span class="n">kws</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;tvib&quot;</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span>

        <span class="n">nv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">f_vibro</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">tvib</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

        <span class="p">(</span><span class="n">l1</span><span class="p">,)</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
            <span class="n">nv</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="s2">&quot;s-&quot;</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">ms</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;$T_</span><span class="se">{{</span><span class="s2">vib</span><span class="se">}}</span><span class="s2"> = </span><span class="si">{</span><span class="n">tvib</span><span class="si">:</span><span class="s2">.0f</span><span class="si">}</span><span class="s2">$K&quot;</span>
        <span class="p">)</span>
        <span class="n">nde</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bp</span><span class="o">.</span><span class="n">nd_vibrofit</span>
        <span class="p">(</span><span class="n">l2</span><span class="p">,)</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">nde</span> <span class="o">/</span> <span class="n">nde</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">nv</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;ko-&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;data&quot;</span><span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">locator_params</span><span class="p">(</span><span class="n">nbins</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.98</span><span class="p">,</span> <span class="mf">1.02</span><span class="p">,</span> <span class="s2">&quot;T/1000K&quot;</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">ax</span><span class="o">.</span><span class="n">transAxes</span><span class="p">)</span>
        <span class="n">pl0</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span>
            <span class="n">handles</span><span class="o">=</span><span class="n">gls</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">prop</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;size&quot;</span><span class="p">:</span> <span class="mi">7</span><span class="p">},</span> <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">[</span><span class="mf">1.13</span><span class="p">,</span> <span class="mf">1.01</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">add_artist</span><span class="p">(</span><span class="n">pl0</span><span class="p">)</span>  <span class="c1"># first legned we must add manually</span>
        <span class="n">pl1</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">handles</span><span class="o">=</span><span class="p">[</span><span class="n">l1</span><span class="p">,</span> <span class="n">l2</span><span class="p">])</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;vibrational q.n.&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;relative pop. of $d^3\Pi_u$&quot;</span><span class="p">)</span></div>

    <span class="c1"># ==================================================</span>
    <span class="c1">#</span>
    <span class="c1">#  Coronal Model Functions from Niihama and Ishihara.</span>
    <span class="c1">#</span>
    <span class="c1"># ==================================================</span>

<div class="viewcode-block" id="CoronaModel.branching"><a class="viewcode-back" href="../../fulcheranalyzer.coronalmodel.html#fulcheranalyzer.coronalmodel.CoronaModel.branching">[docs]</a>    <span class="k">def</span> <span class="nf">branching</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">JX</span><span class="p">,</span> <span class="n">Jd</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; </span>
<span class="sd">        branching ratio </span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        JX: int</span>
<span class="sd">            X-state rotational quantum number</span>
<span class="sd">        Jd: int</span>
<span class="sd">            d-state rotational quantum number</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">sympy.physics.wigner</span> <span class="kn">import</span> <span class="n">wigner_3j</span>

        <span class="n">Qr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.76</span><span class="p">,</span> <span class="mf">0.122</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.014</span><span class="p">])</span>
        <span class="k">return</span> <span class="nb">float</span><span class="p">(</span>
            <span class="nb">sum</span><span class="p">(</span>
                <span class="p">[</span>
                    <span class="n">Qr</span><span class="p">[</span><span class="n">r</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">Jd</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">wigner_3j</span><span class="p">(</span><span class="n">Jd</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">JX</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="o">**</span> <span class="mi">2</span>
                    <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="p">]</span>
            <span class="p">)</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="CoronaModel.calc_branching_matrix"><a class="viewcode-back" href="../../fulcheranalyzer.coronalmodel.html#fulcheranalyzer.coronalmodel.CoronaModel.calc_branching_matrix">[docs]</a>    <span class="k">def</span> <span class="nf">calc_branching_matrix</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">JXmax</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">Jdmax</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate branching ratio matrix, `axd`</span>
<span class="sd">        Jd = index + 1 (start from 1, not 0, range(1,Jdmax))</span>
<span class="sd">        Jx = index</span>

<span class="sd">        Parameters</span>
<span class="sd">        -----------</span>
<span class="sd">        JXmax: int</span>
<span class="sd">            Maximum value for X-state rotational quantum number</span>

<span class="sd">        Jdmax: int</span>
<span class="sd">            Maximum value for d-state rotational quantum number</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">branching</span><span class="p">(</span><span class="n">JX</span><span class="p">,</span> <span class="n">Jd</span><span class="p">)</span> <span class="k">for</span> <span class="n">Jd</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">Jdmax</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)]</span>
                <span class="k">for</span> <span class="n">JX</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">JXmax</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
            <span class="p">]</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="CoronaModel.calc_delta"><a class="viewcode-back" href="../../fulcheranalyzer.coronalmodel.html#fulcheranalyzer.coronalmodel.CoronaModel.calc_delta">[docs]</a>    <span class="k">def</span> <span class="nf">calc_delta</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">axd</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; </span>
<span class="sd">        Calculate Kronecker-s delta matrix, </span>
<span class="sd">        isotop = [&#39;d&#39;,&#39;h&#39;]</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        axd: array</span>
<span class="sd">        isotop: string</span>
<span class="sd">            &#39;d&#39; or &#39;h&#39;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="p">[</span>
                    <span class="n">delta_kro</span><span class="p">(</span>
                        <span class="n">g_as</span><span class="p">(</span><span class="n">JX</span><span class="p">,</span> <span class="n">isotop</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">isotop</span><span class="p">),</span> <span class="n">g_as</span><span class="p">(</span><span class="n">Jd</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">isotop</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">isotop</span><span class="p">)</span>
                    <span class="p">)</span>
                    <span class="k">for</span> <span class="n">Jd</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">axd</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                <span class="p">]</span>
                <span class="k">for</span> <span class="n">JX</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">axd</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="p">]</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="CoronaModel.ccs_formula"><a class="viewcode-back" href="../../fulcheranalyzer.coronalmodel.html#fulcheranalyzer.coronalmodel.CoronaModel.ccs_formula">[docs]</a>    <span class="k">def</span> <span class="nf">ccs_formula</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vX</span><span class="p">,</span> <span class="n">vd</span><span class="p">,</span> <span class="n">Te</span><span class="o">=</span><span class="mi">15</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; </span>
<span class="sd">        Collisional cross section formula</span>
<span class="sd">        Te in [eV]</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        vX: int</span>
<span class="sd">            X-state vibrational quantum number</span>
<span class="sd">        vd: int</span>
<span class="sd">            d-state vibrational quantum number</span>
<span class="sd">        Te: float</span>
<span class="sd">            electron temperature [eV]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">evd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mol</span><span class="o">.</span><span class="n">calculate_E_vib</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="n">state</span><span class="o">=</span><span class="s2">&quot;d3&quot;</span><span class="p">,</span> <span class="n">isotop</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">isotop</span><span class="p">)</span>
        <span class="n">evx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mol</span><span class="o">.</span><span class="n">calculate_E_vib</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="n">state</span><span class="o">=</span><span class="s2">&quot;X&quot;</span><span class="p">,</span> <span class="n">isotop</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">isotop</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">((</span><span class="n">evd</span><span class="p">[</span><span class="n">vd</span><span class="p">]</span> <span class="o">-</span> <span class="n">evd</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">-</span> <span class="p">(</span><span class="n">evx</span><span class="p">[</span><span class="n">vX</span><span class="p">]</span> <span class="o">-</span> <span class="n">evx</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span> <span class="o">/</span> <span class="n">Te</span><span class="p">)</span></div>

<div class="viewcode-block" id="CoronaModel.calc_rtp"><a class="viewcode-back" href="../../fulcheranalyzer.coronalmodel.html#fulcheranalyzer.coronalmodel.CoronaModel.calc_rtp">[docs]</a>    <span class="k">def</span> <span class="nf">calc_rtp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; </span>
<span class="sd">        Calculate rtp (radiation transition probability), like in Ishihara-s code</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># x,d = [como.popshape[&#39;jxlen&#39;],como.popshape[&#39;jdlen&#39;]]</span>
        <span class="n">x</span><span class="p">,</span> <span class="n">d</span> <span class="o">=</span> <span class="p">[</span><span class="mi">30</span><span class="p">,</span> <span class="mi">15</span><span class="p">]</span>
        <span class="n">br</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">([</span><span class="n">x</span><span class="p">,</span> <span class="n">d</span><span class="p">])</span>
        <span class="n">dl</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">([</span><span class="n">x</span><span class="p">,</span> <span class="n">d</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">jx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">jd</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">d</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                <span class="n">br</span><span class="p">[</span><span class="n">jx</span><span class="p">,</span> <span class="n">jd</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">branching</span><span class="p">(</span><span class="n">jx</span><span class="p">,</span> <span class="n">jd</span><span class="p">)</span>
                <span class="n">dl</span><span class="p">[</span><span class="n">jx</span><span class="p">,</span> <span class="n">jd</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">delta_kro</span><span class="p">(</span>
                    <span class="n">g_as</span><span class="p">(</span><span class="n">jx</span><span class="p">,</span> <span class="n">isotop</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">isotop</span><span class="p">),</span> <span class="n">g_as</span><span class="p">(</span><span class="n">jd</span><span class="p">,</span> <span class="n">isotop</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">isotop</span><span class="p">)</span>
                <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rtp</span> <span class="o">=</span> <span class="n">br</span> <span class="o">*</span> <span class="n">dl</span></div>

<div class="viewcode-block" id="CoronaModel.R_formula"><a class="viewcode-back" href="../../fulcheranalyzer.coronalmodel.html#fulcheranalyzer.coronalmodel.CoronaModel.R_formula">[docs]</a>    <span class="k">def</span> <span class="nf">R_formula</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vX</span><span class="p">,</span> <span class="n">JX</span><span class="p">,</span> <span class="n">vd</span><span class="p">,</span> <span class="n">Jdind</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; </span>
<span class="sd">        Calculate electron impact excitation rate coefficient</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        vX: int</span>
<span class="sd">            X-state vibrational quantum number</span>
<span class="sd">        JX: int</span>
<span class="sd">            X-state rotational quantum number</span>
<span class="sd">        vd: int</span>
<span class="sd">            d-state vibrational quantum number</span>
<span class="sd">        Jdind: int</span>
<span class="sd">            index for d-state rotational quantum number</span>
<span class="sd">            Jdind = Jd-1, Jd starts from 1 in `self.rtp`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># FCF indices</span>
        <span class="c1"># If in numpy, then `fcf[d][X]`, if in pandas, then `fcf[X][d]`</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">isotop</span> <span class="o">==</span> <span class="s2">&quot;d&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fcf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mol</span><span class="o">.</span><span class="n">corona_constants_d</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">isotop</span> <span class="o">==</span> <span class="s2">&quot;h&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fcf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mol</span><span class="o">.</span><span class="n">corona_constants_h</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="c1"># new (Ishihara-s formula)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">fcf</span><span class="p">[</span><span class="n">vX</span><span class="p">][</span><span class="n">vd</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">ccs_formula</span><span class="p">(</span><span class="n">vX</span><span class="p">,</span> <span class="n">vd</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">rtp</span><span class="p">[</span><span class="n">JX</span><span class="p">,</span> <span class="n">Jdind</span><span class="p">]</span>

        <span class="c1"># old formula</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        return (</span>
<span class="sd">            self.fcf[vX][vd]</span>
<span class="sd">            * self.ccs_formula(vX, vd)</span>
<span class="sd">            * self.branching(JX, Jd)</span>
<span class="sd">            * delta_kro(g_as(JX, isotop=self.isotop), g_as(Jd, isotop=self.isotop))</span>
<span class="sd">        )   </span>
<span class="sd">        &quot;&quot;&quot;</span></div>

        <span class="c1"># Ishihara-s formula: branching[jx, jd] * fcf[vx, vd] * ccs[vx, vd]</span>
        <span class="c1"># Ishihara-s branching includes kronecker-s delta</span>

<div class="viewcode-block" id="CoronaModel.prep_corona_fit"><a class="viewcode-back" href="../../fulcheranalyzer.coronalmodel.html#fulcheranalyzer.coronalmodel.CoronaModel.prep_corona_fit">[docs]</a>    <span class="k">def</span> <span class="nf">prep_corona_fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">load</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; </span>
<span class="sd">        Prep proper corona.</span>
<span class="sd">        setup X and d states shapes, calculate R-matrix</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        load: bool</span>
<span class="sd">            True try to load previously calculated matrix to save time.</span>
<span class="sd">            CAUTION: must recalculate this matrix if the model changed.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">dshape</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bp</span><span class="o">.</span><span class="n">nd</span><span class="o">.</span><span class="n">shape</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_pop_shape</span><span class="p">([</span><span class="n">dshape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">dshape</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">make_rmatrix</span><span class="p">(</span><span class="n">load</span><span class="o">=</span><span class="n">load</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">EX</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mol</span><span class="o">.</span><span class="n">calculate_E_rot</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">popshape</span><span class="p">[</span><span class="s2">&quot;vxlen&quot;</span><span class="p">],</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">popshape</span><span class="p">[</span><span class="s2">&quot;jxlen&quot;</span><span class="p">],</span>
            <span class="n">isotop</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">isotop</span><span class="p">,</span>
            <span class="n">state</span><span class="o">=</span><span class="s2">&quot;X&quot;</span><span class="p">,</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="CoronaModel.set_pop_shape"><a class="viewcode-back" href="../../fulcheranalyzer.coronalmodel.html#fulcheranalyzer.coronalmodel.CoronaModel.set_pop_shape">[docs]</a>    <span class="k">def</span> <span class="nf">set_pop_shape</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">limits</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; </span>
<span class="sd">        Set population shape for d and X levels</span>
<span class="sd">        NOTE: jd here is an index. Actual JD is JD+1</span>
<span class="sd">        There is no Jd=0 for d-state. But numpy matrix indexing starts from 0.</span>
<span class="sd">        That is why max(jx) &gt;= max(jd) + 1</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        limits: array</span>
<span class="sd">            limits = [&#39;vx&#39;,&#39;jx&#39;]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">dshape</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bp</span><span class="o">.</span><span class="n">nd</span><span class="o">.</span><span class="n">shape</span>
        <span class="n">limits</span> <span class="o">=</span> <span class="p">[</span><span class="n">dshape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">dshape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">limits</span>
        <span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;vd&quot;</span><span class="p">,</span> <span class="s2">&quot;jd&quot;</span><span class="p">,</span> <span class="s2">&quot;vx&quot;</span><span class="p">,</span> <span class="s2">&quot;jx&quot;</span><span class="p">]</span>
        <span class="n">x</span> <span class="o">=</span> <span class="p">{</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">n</span><span class="si">}</span><span class="s2">max&quot;</span><span class="p">:</span> <span class="n">l</span> <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">names</span><span class="p">,</span> <span class="n">limits</span><span class="p">)}</span>
        <span class="n">y</span> <span class="o">=</span> <span class="p">{</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">n</span><span class="si">}</span><span class="s2">len&quot;</span><span class="p">:</span> <span class="n">l</span> <span class="o">+</span> <span class="mi">1</span> <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">names</span><span class="p">,</span> <span class="n">limits</span><span class="p">)}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">popshape</span> <span class="o">=</span> <span class="n">x</span> <span class="o">|</span> <span class="n">y</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rshapelist</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">popshape</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">len&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;vd&quot;</span><span class="p">,</span> <span class="s2">&quot;jd&quot;</span><span class="p">,</span> <span class="s2">&quot;vx&quot;</span><span class="p">,</span> <span class="s2">&quot;jx&quot;</span><span class="p">]]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">popshape</span><span class="p">[</span><span class="s2">&quot;jxmax&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">popshape</span><span class="p">[</span><span class="s2">&quot;jdmax&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Must be: jxmax &gt;= </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">popshape</span><span class="p">[</span><span class="s1">&#39;jdmax&#39;</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">, now jxmax=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">popshape</span><span class="p">[</span><span class="s1">&#39;jxmax&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">.&quot;</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">popshape</span><span class="p">[</span><span class="s2">&quot;vxmax&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">popshape</span><span class="p">[</span><span class="s2">&quot;vdmax&quot;</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;X-state v range (0-</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">popshape</span><span class="p">[</span><span class="s1">&#39;vxmax&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">) must be&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot; at least equal to d-state v range (0-</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">popshape</span><span class="p">[</span><span class="s1">&#39;vdmax&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">)&quot;</span>
                <span class="p">)</span>
            <span class="p">)</span></div>

<div class="viewcode-block" id="CoronaModel.print_pop_shape"><a class="viewcode-back" href="../../fulcheranalyzer.coronalmodel.html#fulcheranalyzer.coronalmodel.CoronaModel.print_pop_shape">[docs]</a>    <span class="k">def</span> <span class="nf">print_pop_shape</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; </span>
<span class="sd">        Print vx, jx, vd, jd</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">sh</span> <span class="o">=</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;vd = 0-</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">popshape</span><span class="p">[</span><span class="s1">&#39;vdmax&#39;</span><span class="p">]</span><span class="si">}</span><span class="se">\t</span><span class="s2">Jd = 1-</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">popshape</span><span class="p">[</span><span class="s1">&#39;jdmax&#39;</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;vX = 0-</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">popshape</span><span class="p">[</span><span class="s1">&#39;vxmax&#39;</span><span class="p">]</span><span class="si">}</span><span class="se">\t</span><span class="s2">Jx = 0-</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">popshape</span><span class="p">[</span><span class="s1">&#39;jxmax&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">sh</span><span class="p">)</span></div>

<div class="viewcode-block" id="CoronaModel.make_rmatrix"><a class="viewcode-back" href="../../fulcheranalyzer.coronalmodel.html#fulcheranalyzer.coronalmodel.CoronaModel.make_rmatrix">[docs]</a>    <span class="k">def</span> <span class="nf">make_rmatrix</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">load</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; </span>
<span class="sd">        Calculate R matrix for given isotop</span>
<span class="sd">        If formula changed, RECALCULATE! argument `load = False`   </span>

<span class="sd">        NOTE! Jd starts from 1. Index 0 in Jd axis corresponds to Jd=1</span>

<span class="sd">        Parameters</span>
<span class="sd">        -----------</span>
<span class="sd">        load: bool</span>
<span class="sd">            True - load previously calculated matrix, False - recalculate. </span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">vxmax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">popshape</span><span class="p">[</span><span class="s2">&quot;vxmax&quot;</span><span class="p">]</span>
        <span class="n">jxmax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">popshape</span><span class="p">[</span><span class="s2">&quot;jxmax&quot;</span><span class="p">]</span>
        <span class="n">vdmax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">popshape</span><span class="p">[</span><span class="s2">&quot;vdmax&quot;</span><span class="p">]</span>
        <span class="n">jdmax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">popshape</span><span class="p">[</span><span class="s2">&quot;jdmax&quot;</span><span class="p">]</span>

        <span class="n">fname</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Rmatrix_</span><span class="si">{</span><span class="n">vxmax</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">jxmax</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">vdmax</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">jdmax</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">isotop</span><span class="si">}</span><span class="s2">.npy&quot;</span>
        <span class="n">fpth</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">MOLECULAR_DATA_FOLDER</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">fname</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">load</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">Rm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">fpth</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;saved R-matrix found, loaded&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">make_rmatrix_2d</span><span class="p">()</span>
                <span class="k">return</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;could not load, calculating R-matrix&quot;</span><span class="p">)</span>

        <span class="n">Rmatrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">([</span><span class="n">vxmax</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">jxmax</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">vdmax</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">jdmax</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">vx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">vxmax</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">jx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">jxmax</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">vd</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">vdmax</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">jd</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">jdmax</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                        <span class="c1"># Rmatrix[vx, jx, vd, jd] = self.R_formula(vx, jx, vd, jd)</span>
                        <span class="n">Rmatrix</span><span class="p">[</span><span class="n">vx</span><span class="p">,</span> <span class="n">jx</span><span class="p">,</span> <span class="n">vd</span><span class="p">,</span> <span class="n">jd</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">fcf</span><span class="p">[</span><span class="n">vx</span><span class="p">,</span> <span class="n">vd</span><span class="p">]</span>
                            <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">ccs_formula</span><span class="p">(</span><span class="n">vx</span><span class="p">,</span> <span class="n">vd</span><span class="p">)</span>
                            <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">rtp</span><span class="p">[</span><span class="n">jx</span><span class="p">,</span> <span class="n">jd</span><span class="p">]</span>
                        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">Rm</span> <span class="o">=</span> <span class="n">Rmatrix</span>
        <span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">fpth</span><span class="p">,</span> <span class="n">Rmatrix</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">make_rmatrix_2d</span><span class="p">()</span></div>

<div class="viewcode-block" id="CoronaModel.make_rmatrix_2d"><a class="viewcode-back" href="../../fulcheranalyzer.coronalmodel.html#fulcheranalyzer.coronalmodel.CoronaModel.make_rmatrix_2d">[docs]</a>    <span class="k">def</span> <span class="nf">make_rmatrix_2d</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; </span>
<span class="sd">        Reshape R matrix (electron impact excitation rate)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Rm2d</span> <span class="o">=</span> <span class="n">reshape_4d2d</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Rm</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>  <span class="c1"># transpose for correct orientation</span></div>

<div class="viewcode-block" id="CoronaModel.check_rmatrix_indexing"><a class="viewcode-back" href="../../fulcheranalyzer.coronalmodel.html#fulcheranalyzer.coronalmodel.CoronaModel.check_rmatrix_indexing">[docs]</a>    <span class="k">def</span> <span class="nf">check_rmatrix_indexing</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; </span>
<span class="sd">        Check Rmatrix indexing</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">operator</span> <span class="kn">import</span> <span class="n">mul</span>
        <span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">reduce</span>

        <span class="n">vx</span><span class="p">,</span> <span class="n">jx</span><span class="p">,</span> <span class="n">vd</span><span class="p">,</span> <span class="n">jd</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;vX=</span><span class="si">{</span><span class="n">vx</span><span class="si">}</span><span class="s2"> jX=</span><span class="si">{</span><span class="n">jx</span><span class="si">}</span><span class="s2"> vd=</span><span class="si">{</span><span class="n">vd</span><span class="si">}</span><span class="s2"> jd=</span><span class="si">{</span><span class="n">jd</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">a</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Rm</span><span class="p">[</span><span class="n">vx</span><span class="p">,</span> <span class="n">jx</span><span class="p">,</span> <span class="n">vd</span><span class="p">,</span> <span class="n">jd</span><span class="p">]</span>
        <span class="n">b</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">R_formula</span><span class="p">(</span><span class="n">vx</span><span class="p">,</span> <span class="n">jx</span><span class="p">,</span> <span class="n">vd</span><span class="p">,</span> <span class="n">jd</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;valid: </span><span class="si">{</span><span class="n">a</span><span class="o">==</span><span class="n">b</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;matrix shape = </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">Rm</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;matrix shape sum = </span><span class="si">{</span><span class="n">reduce</span><span class="p">(</span><span class="n">mul</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Rm</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="CoronaModel.calc_X_bp"><a class="viewcode-back" href="../../fulcheranalyzer.coronalmodel.html#fulcheranalyzer.coronalmodel.CoronaModel.calc_X_bp">[docs]</a>    <span class="k">def</span> <span class="nf">calc_X_bp</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">Tvib</span><span class="o">=</span><span class="mf">5000.0</span><span class="p">,</span> <span class="n">Trot1</span><span class="o">=</span><span class="mf">200.0</span><span class="p">,</span> <span class="n">Trot2</span><span class="o">=</span><span class="mf">1000.0</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">beta</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">const</span><span class="o">=</span><span class="mf">1.0</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; </span>
<span class="sd">        Calculate synthetic Boltzmann plot of the X-state (nx*g_as*(2J+1))</span>
<span class="sd">        with one Tvib and two Trot</span>
<span class="sd">        Jmax is limited by the Franck-Condon data</span>
<span class="sd">        higher vmax have smaller contribution to d-state population. </span>
<span class="sd">        Temperatures in K</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        Tvib: float</span>
<span class="sd">            X-state vibrational temperature</span>
<span class="sd">        Trot1: float</span>
<span class="sd">            X-state low rotational temperature</span>
<span class="sd">        Trot2: float</span>
<span class="sd">            X-state high rotational temperature</span>
<span class="sd">        alpha: float</span>
<span class="sd">            exponent mixing coefficient for v=0</span>
<span class="sd">        beta: float</span>
<span class="sd">            exponent mixing coefficient for v&gt;0</span>
<span class="sd">        const: float</span>
<span class="sd">            constant multiplyer for the distribution</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">scipy.constants</span> <span class="kn">import</span> <span class="n">Boltzmann</span><span class="p">,</span> <span class="n">elementary_charge</span>

        <span class="n">vmax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">popshape</span><span class="p">[</span><span class="s2">&quot;vxmax&quot;</span><span class="p">]</span>
        <span class="n">Jmax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">popshape</span><span class="p">[</span><span class="s2">&quot;jxmax&quot;</span><span class="p">]</span>

        <span class="n">kb</span> <span class="o">=</span> <span class="n">Boltzmann</span> <span class="o">/</span> <span class="n">elementary_charge</span>
        <span class="n">Evib</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mol</span><span class="o">.</span><span class="n">calculate_E_vib</span><span class="p">(</span><span class="n">Jmax</span><span class="p">,</span> <span class="n">state</span><span class="o">=</span><span class="s2">&quot;X&quot;</span><span class="p">,</span> <span class="n">isotop</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">isotop</span><span class="p">)</span>
        <span class="n">Erot</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mol</span><span class="o">.</span><span class="n">calculate_E_rot</span><span class="p">(</span>
            <span class="n">vmax</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">Jmax</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">isotop</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">isotop</span><span class="p">,</span> <span class="n">state</span><span class="o">=</span><span class="s2">&quot;X&quot;</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mol</span><span class="o">.</span><span class="n">calculate_tfrac</span><span class="p">(</span><span class="n">vmax</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">frac</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mol</span><span class="o">.</span><span class="n">frac</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">isotop</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">alphabeta</span> <span class="o">=</span> <span class="p">[</span><span class="n">alpha</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">vmax</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)]</span>  <span class="c1"># no mixing</span>
        <span class="c1"># Ishihara-s &quot;mixing&quot; of two exponents</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">isotop</span> <span class="o">==</span> <span class="s2">&quot;d&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">alphabeta</span> <span class="o">=</span> <span class="p">[</span><span class="n">beta</span><span class="p">,</span> <span class="n">beta</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">alpha</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">isotop</span> <span class="o">==</span> <span class="s2">&quot;h&quot;</span><span class="p">:</span>
            <span class="c1"># self.alphabeta = [beta, beta, alpha] # Ishihara-s pattern</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">alphabeta</span> <span class="o">=</span> <span class="p">[</span><span class="n">beta</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">alpha</span><span class="p">]</span>  <span class="c1"># this seems to be better</span>
        <span class="n">ab</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">alphabeta</span>

        <span class="n">nxbp</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">[</span>
                <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">Evib</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="n">kb</span> <span class="o">*</span> <span class="n">Tvib</span><span class="p">))</span>
                <span class="o">*</span> <span class="p">(</span>
                    <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">ab</span><span class="p">[</span><span class="n">v</span><span class="p">])</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">Erot</span><span class="p">[</span><span class="n">v</span><span class="p">][</span><span class="n">J</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="n">kb</span> <span class="o">*</span> <span class="n">Trot1</span> <span class="o">*</span> <span class="n">frac</span><span class="p">[</span><span class="n">v</span><span class="p">]))</span>
                    <span class="o">+</span> <span class="n">ab</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">Erot</span><span class="p">[</span><span class="n">v</span><span class="p">][</span><span class="n">J</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="n">kb</span> <span class="o">*</span> <span class="n">Trot2</span> <span class="o">*</span> <span class="n">frac</span><span class="p">[</span><span class="n">v</span><span class="p">]))</span>
                <span class="p">)</span>
                <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">vmax</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
            <span class="p">]</span>
            <span class="k">for</span> <span class="n">J</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Jmax</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">nxbp</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">nxbp</span><span class="p">)</span> <span class="o">*</span> <span class="n">const</span></div>

<div class="viewcode-block" id="CoronaModel.calc_nx"><a class="viewcode-back" href="../../fulcheranalyzer.coronalmodel.html#fulcheranalyzer.coronalmodel.CoronaModel.calc_nx">[docs]</a>    <span class="k">def</span> <span class="nf">calc_nx</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate X-state population</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        arg: list</span>
<span class="sd">            arg = [5000,200,1000,0.1,1,3,15]</span>
<span class="sd">            list of parameters for :func:`~self.calc_X_bp`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Tvib, Trot1, Trot2, alpha, const= arg</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">calc_X_bp</span><span class="p">(</span><span class="o">*</span><span class="n">arg</span><span class="p">)</span>

        <span class="n">gasvect</span> <span class="o">=</span> <span class="n">g_as_vector</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nxbp</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">transpose</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">isotop</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">isotop</span><span class="p">,</span> <span class="n">j0</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="n">tjpo</span> <span class="o">=</span> <span class="n">tjpo_vector</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nxbp</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">transpose</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">j0</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nxbp</span> <span class="o">*</span> <span class="n">gasvect</span> <span class="o">*</span> <span class="n">tjpo</span></div>

<div class="viewcode-block" id="CoronaModel.calc_nd"><a class="viewcode-back" href="../../fulcheranalyzer.coronalmodel.html#fulcheranalyzer.coronalmodel.CoronaModel.calc_nd">[docs]</a>    <span class="k">def</span> <span class="nf">calc_nd</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; </span>
<span class="sd">        Calculate d-state population using Corona Model</span>
<span class="sd">        X-state population must be calculated first</span>
<span class="sd">        Using numpy matrix multiplication for this, same as Ishihara.</span>
<span class="sd">        This is ~ 100 times faster compared to using formula in loops,</span>
<span class="sd">        as in Niihama-kun-s code.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">nmulti</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Rm2d</span> <span class="o">@</span> <span class="bp">self</span><span class="o">.</span><span class="n">nx</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">order</span><span class="o">=</span><span class="s2">&quot;f&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nd</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
            <span class="n">nmulti</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">popshape</span><span class="p">[</span><span class="s2">&quot;vdlen&quot;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">popshape</span><span class="p">[</span><span class="s2">&quot;jdlen&quot;</span><span class="p">])</span>
        <span class="p">)</span><span class="o">.</span><span class="n">T</span></div>

<div class="viewcode-block" id="CoronaModel.calc_ndx"><a class="viewcode-back" href="../../fulcheranalyzer.coronalmodel.html#fulcheranalyzer.coronalmodel.CoronaModel.calc_ndx">[docs]</a>    <span class="k">def</span> <span class="nf">calc_ndx</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">Tvib</span><span class="o">=</span><span class="mf">5000.0</span><span class="p">,</span> <span class="n">Trot1</span><span class="o">=</span><span class="mf">200.0</span><span class="p">,</span> <span class="n">Trot2</span><span class="o">=</span><span class="mf">1000.0</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.4</span><span class="p">,</span> <span class="n">beta</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">const</span><span class="o">=</span><span class="mf">1.0</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; </span>
<span class="sd">        Construct synthetic population of X-state with calc_nx()</span>
<span class="sd">        Calculate population of d-state from nX using Corona model calc_nd()</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">calc_nx</span><span class="p">([</span><span class="n">Tvib</span><span class="p">,</span> <span class="n">Trot1</span><span class="p">,</span> <span class="n">Trot2</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">beta</span><span class="p">,</span> <span class="n">const</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">calc_nd</span><span class="p">()</span></div>

<div class="viewcode-block" id="CoronaModel.plot_xd"><a class="viewcode-back" href="../../fulcheranalyzer.coronalmodel.html#fulcheranalyzer.coronalmodel.CoronaModel.plot_xd">[docs]</a>    <span class="k">def</span> <span class="nf">plot_xd</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; plot synthetic nX and nd&quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

        <span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">set_size_inches</span><span class="p">([</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">])</span>

        <span class="p">[</span><span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nx</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;v=</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nx</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span>
        <span class="p">[</span><span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nd</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;v=</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nd</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span>
        <span class="p">[</span><span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span> <span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">axs</span><span class="p">]</span>
        <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">,</span> <span class="s2">&quot;$X^1\Sigma^{+}_</span><span class="si">{g}</span><span class="s2">$&quot;</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">transAxes</span><span class="p">)</span>
        <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">,</span> <span class="s2">&quot;$d^3\Pi_</span><span class="si">{u}</span><span class="s2">$&quot;</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">transAxes</span><span class="p">)</span></div>

<div class="viewcode-block" id="CoronaModel.plot_xd_flat"><a class="viewcode-back" href="../../fulcheranalyzer.coronalmodel.html#fulcheranalyzer.coronalmodel.CoronaModel.plot_xd_flat">[docs]</a>    <span class="k">def</span> <span class="nf">plot_xd_flat</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kws</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot flattened X and d populations</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
        <span class="kn">from</span> <span class="nn">math</span> <span class="kn">import</span> <span class="n">ceil</span>

        <span class="n">ax</span> <span class="o">=</span> <span class="n">kws</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;ax&quot;</span><span class="p">,</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">())</span>

        <span class="n">ndeflat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bp</span><span class="o">.</span><span class="n">nd_sc</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">order</span><span class="o">=</span><span class="s2">&quot;f&quot;</span><span class="p">)</span>
        <span class="n">ndflat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nd</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">order</span><span class="o">=</span><span class="s2">&quot;f&quot;</span><span class="p">)</span>

        <span class="n">mask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bp</span><span class="o">.</span><span class="n">mask</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">order</span><span class="o">=</span><span class="s2">&quot;f&quot;</span><span class="p">)</span>
        <span class="n">x_ndem</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">mask</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])[</span><span class="n">mask</span><span class="p">]</span>
        <span class="n">ndemflat</span> <span class="o">=</span> <span class="n">ndeflat</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">sca</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ndeflat</span> <span class="o">/</span> <span class="n">ndeflat</span><span class="o">.</span><span class="n">sum</span><span class="p">(),</span> <span class="s2">&quot;ko-&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;exp-synth&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_ndem</span><span class="p">,</span> <span class="n">ndemflat</span> <span class="o">/</span> <span class="n">ndeflat</span><span class="o">.</span><span class="n">sum</span><span class="p">(),</span> <span class="s2">&quot;C3s&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;data&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ndflat</span> <span class="o">/</span> <span class="n">ndflat</span><span class="o">.</span><span class="n">sum</span><span class="p">(),</span> <span class="s2">&quot;C2x-.&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;corona&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">ceil</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nd</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">nd</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="mi">5</span><span class="p">)</span> <span class="o">*</span> <span class="mi">5</span><span class="p">)</span></div>

<div class="viewcode-block" id="CoronaModel.plot_paper_compare"><a class="viewcode-back" href="../../fulcheranalyzer.coronalmodel.html#fulcheranalyzer.coronalmodel.CoronaModel.plot_paper_compare">[docs]</a>    <span class="k">def</span> <span class="nf">plot_paper_compare</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kws</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot comparison of experimental population of d-state</span>
<span class="sd">        with Corona-Model reconstructed one (p.39 fig. 4.24 Ishihara-s thesis)</span>
<span class="sd">        (or Figures 11 and 12 from JQSRT-2021 paper)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

        <span class="n">ax</span> <span class="o">=</span> <span class="n">kws</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;ax&quot;</span><span class="p">,</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">())</span>

        <span class="s2">&quot;nd - n(d3), nde - nd experimental, ndes - nd experimental synthetic (fit)&quot;</span>
        <span class="n">ndeflat</span> <span class="o">=</span> <span class="n">flatdf</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bp</span><span class="o">.</span><span class="n">nd</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">bp</span><span class="o">.</span><span class="n">mask</span><span class="p">])</span>  <span class="c1"># experimental data</span>
        <span class="n">nd_err</span> <span class="o">=</span> <span class="n">flatdf</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bp</span><span class="o">.</span><span class="n">nd_err</span><span class="p">)</span>  <span class="c1"># experimental error</span>
        <span class="n">ndesflat</span> <span class="o">=</span> <span class="n">flatdf</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bp</span><span class="o">.</span><span class="n">nd_sc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">bp</span><span class="o">.</span><span class="n">mask</span><span class="p">])</span>  <span class="c1"># boltzmann fit of d-state</span>
        <span class="n">ndflat</span> <span class="o">=</span> <span class="n">flatdf</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nd</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">bp</span><span class="o">.</span><span class="n">mask</span><span class="p">])</span>  <span class="c1"># corona reconstruction of d-state</span>
        <span class="c1"># normalize bu the sum()</span>
        <span class="n">ndflat</span> <span class="o">=</span> <span class="n">ndflat</span> <span class="o">/</span> <span class="n">ndflat</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>  <span class="c1"># corona</span>
        <span class="n">nd_err</span> <span class="o">=</span> <span class="n">nd_err</span> <span class="o">/</span> <span class="n">ndeflat</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>  <span class="c1"># experimental error, ORDER MATTERS!</span>
        <span class="n">ndeflat</span> <span class="o">=</span> <span class="n">ndeflat</span> <span class="o">/</span> <span class="n">ndeflat</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>  <span class="c1"># experiment</span>
        <span class="n">ndesflat</span> <span class="o">=</span> <span class="n">ndesflat</span> <span class="o">/</span> <span class="n">ndesflat</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>  <span class="c1"># boltzmann fit</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">sca</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>
        <span class="c1"># plt.plot(ndeflat, &quot;ko-&quot;, label=&quot;exp-data&quot;)</span>
        <span class="n">ms</span> <span class="o">=</span> <span class="n">kws</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;ms&quot;</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prep_style</span><span class="p">(</span><span class="n">ms</span><span class="o">=</span><span class="n">ms</span><span class="p">)</span>
        <span class="n">style</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">style_coronaplot</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ndeflat</span><span class="p">))</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">ndeflat</span><span class="p">,</span> <span class="n">yerr</span><span class="o">=</span><span class="n">nd_err</span><span class="p">,</span> <span class="o">**</span><span class="n">style</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">showbp</span> <span class="o">=</span> <span class="n">kws</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;showbp&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">showbp</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ndesflat</span><span class="p">,</span> <span class="s2">&quot;C1o-.&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;BP-fit&quot;</span><span class="p">)</span>
        <span class="n">yerr</span> <span class="o">=</span> <span class="n">kws</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;yerr&quot;</span><span class="p">,</span> <span class="p">[])</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">yerr</span><span class="p">):</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ndflat</span><span class="p">,</span> <span class="s2">&quot;rs:&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;corona&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">ndflat</span><span class="p">,</span> <span class="n">yerr</span><span class="o">=</span><span class="n">yerr</span><span class="p">,</span> <span class="o">**</span><span class="n">style</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">ndflat</span><span class="p">),</span> <span class="mi">1</span><span class="p">))</span>
        <span class="n">nms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bp</span><span class="o">.</span><span class="n">qnames</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">bp</span><span class="o">.</span><span class="n">mask</span><span class="p">]</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="n">flatdf</span><span class="p">(</span><span class="n">nms</span><span class="p">),</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">90</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Q-branch transition [QN&#39;(v&#39;-v&#39;&#39;)]&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;$\mathdefault{\mathrm{n_{dv\mathrm{&#39;}N\mathrm{&#39;}}}}$ [a.u.]&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="CoronaModel.plot_rtp"><a class="viewcode-back" href="../../fulcheranalyzer.coronalmodel.html#fulcheranalyzer.coronalmodel.CoronaModel.plot_rtp">[docs]</a>    <span class="k">def</span> <span class="nf">plot_rtp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; </span>
<span class="sd">        Plot rtp </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
        <span class="kn">import</span> <span class="nn">matplotlib</span> <span class="k">as</span> <span class="nn">mpl</span>

        <span class="n">im</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rtp</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s2">&quot;lower&quot;</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">seismic</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">mpl</span><span class="o">.</span><span class="n">colors</span><span class="o">.</span><span class="n">LogNorm</span><span class="p">()</span>
        <span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im</span><span class="p">)</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;J&#39;-1 (d)&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;J (X)&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="CoronaModel.plot_R"><a class="viewcode-back" href="../../fulcheranalyzer.coronalmodel.html#fulcheranalyzer.coronalmodel.CoronaModel.plot_R">[docs]</a>    <span class="k">def</span> <span class="nf">plot_R</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        plot R-matrix </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
        <span class="kn">import</span> <span class="nn">matplotlib</span> <span class="k">as</span> <span class="nn">mpl</span>

        <span class="c1"># shp = [self.popshape[f&quot;{i}len&quot;] for i in [&quot;vd&quot;, &quot;jd&quot;, &quot;vx&quot;, &quot;jx&quot;]]</span>
        <span class="n">shp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rshapelist</span>
        <span class="n">plot_rmatrix</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Rm2d</span><span class="p">,</span> <span class="n">shp</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="s2">&quot;R-matrix&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span><span class="o">.</span><span class="n">set_size_inches</span><span class="p">([</span><span class="mi">9</span><span class="p">,</span> <span class="mi">9</span><span class="p">])</span></div>

<div class="viewcode-block" id="CoronaModel.plot_fcf"><a class="viewcode-back" href="../../fulcheranalyzer.coronalmodel.html#fulcheranalyzer.coronalmodel.CoronaModel.plot_fcf">[docs]</a>    <span class="k">def</span> <span class="nf">plot_fcf</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot FCF </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
        <span class="kn">import</span> <span class="nn">matplotlib</span> <span class="k">as</span> <span class="nn">mpl</span>

        <span class="n">fcf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fcf</span><span class="p">[:</span><span class="mi">4</span><span class="p">,</span> <span class="p">:</span><span class="mi">4</span><span class="p">]</span>
        <span class="n">im</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span>
            <span class="n">fcf</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s2">&quot;lower&quot;</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">seismic</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">mpl</span><span class="o">.</span><span class="n">colors</span><span class="o">.</span><span class="n">LogNorm</span><span class="p">()</span>
        <span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im</span><span class="p">)</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">fcf</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">fcf</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;$v$&#39;&#39; ($a^3\Sigma_g^+$)&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;$v$&#39; ($d^3\Pi_u$)&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="CoronaModel.plot_ccs"><a class="viewcode-back" href="../../fulcheranalyzer.coronalmodel.html#fulcheranalyzer.coronalmodel.CoronaModel.plot_ccs">[docs]</a>    <span class="k">def</span> <span class="nf">plot_ccs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot ccs </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
        <span class="kn">import</span> <span class="nn">matplotlib</span> <span class="k">as</span> <span class="nn">mpl</span>

        <span class="n">ccs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ccs</span><span class="o">.</span><span class="n">values</span><span class="p">[:</span><span class="mi">4</span><span class="p">,</span> <span class="p">:</span><span class="mi">4</span><span class="p">]</span>
        <span class="n">im</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">ccs</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s2">&quot;lower&quot;</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">seismic</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im</span><span class="p">)</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">ccs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">ccs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;$v$&#39;&#39; ($a^3\Sigma_g^+$)&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;$v$&#39; ($d^3\Pi_u$)&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="CoronaModel.plot_coronal_result"><a class="viewcode-back" href="../../fulcheranalyzer.coronalmodel.html#fulcheranalyzer.coronalmodel.CoronaModel.plot_coronal_result">[docs]</a>    <span class="k">def</span> <span class="nf">plot_coronal_result</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot two panels with synthetic population and with data only</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
        <span class="kn">from</span> <span class="nn">math</span> <span class="kn">import</span> <span class="n">ceil</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">coronal_fit_formula</span><span class="p">([],</span> <span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">fitres</span><span class="p">)</span>  <span class="c1"># update self.nxbp from self.fitres</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plot_xd_flat</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plot_paper_compare</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">set_size_inches</span><span class="p">([</span><span class="mi">12</span><span class="p">,</span> <span class="mi">10</span><span class="p">])</span></div>

<div class="viewcode-block" id="CoronaModel.plot_contribution"><a class="viewcode-back" href="../../fulcheranalyzer.coronalmodel.html#fulcheranalyzer.coronalmodel.CoronaModel.plot_contribution">[docs]</a>    <span class="k">def</span> <span class="nf">plot_contribution</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Tvib</span><span class="o">=</span><span class="mi">7000</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot contribution of X-state to d-state population</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
        <span class="kn">from</span> <span class="nn">math</span> <span class="kn">import</span> <span class="n">ceil</span>
        <span class="kn">from</span> <span class="nn">scipy.constants</span> <span class="kn">import</span> <span class="n">Boltzmann</span><span class="p">,</span> <span class="n">elementary_charge</span>

        <span class="n">kb</span> <span class="o">=</span> <span class="n">Boltzmann</span> <span class="o">/</span> <span class="n">elementary_charge</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">calculate_e_cross</span><span class="p">()</span>
        <span class="n">ccs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ccs</span><span class="o">.</span><span class="n">values</span>
        <span class="n">fcf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fcf</span>
        <span class="n">E_vib</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">E_vib</span>

        <span class="n">v_range</span> <span class="o">=</span> <span class="mi">15</span>
        <span class="n">vv_range</span> <span class="o">=</span> <span class="mi">4</span>
        <span class="n">nvv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">v_range</span><span class="p">,</span> <span class="n">vv_range</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">v_range</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">vv</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">vv_range</span><span class="p">):</span>
                <span class="n">nvv</span><span class="p">[</span><span class="n">v</span><span class="p">,</span> <span class="n">vv</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">ccs</span><span class="p">[</span><span class="n">v</span><span class="p">,</span> <span class="n">vv</span><span class="p">]</span>
                    <span class="o">*</span> <span class="n">fcf</span><span class="p">[</span><span class="n">v</span><span class="p">,</span> <span class="n">vv</span><span class="p">]</span>
                    <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">E_vib</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">-</span> <span class="n">E_vib</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="n">Tvib</span> <span class="o">*</span> <span class="n">kb</span><span class="p">))</span>
                    <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">Asum</span><span class="p">[</span><span class="n">vv</span><span class="p">]</span>
                    <span class="o">*</span> <span class="mf">1e9</span>
                <span class="p">)</span>

        <span class="n">mks</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;o&quot;</span><span class="p">,</span> <span class="s2">&quot;s&quot;</span><span class="p">,</span> <span class="s2">&quot;^&quot;</span><span class="p">,</span> <span class="s2">&quot;&gt;&quot;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">v_range</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">v</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
                    <span class="n">nvv</span><span class="p">[</span><span class="n">v</span><span class="p">],</span>
                    <span class="s2">&quot;-&quot;</span><span class="p">,</span>
                    <span class="n">color</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">hsv</span><span class="p">(</span><span class="n">v</span> <span class="o">/</span> <span class="mi">4</span><span class="p">),</span>
                    <span class="n">marker</span><span class="o">=</span><span class="n">mks</span><span class="p">[</span><span class="n">v</span><span class="p">],</span>
                    <span class="n">ms</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                    <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;v=</span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="c1"># print(sum(nvv[v, :] / sum(nvv)))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">nvv</span><span class="p">[</span><span class="n">v</span><span class="p">],</span> <span class="s2">&quot;.--&quot;</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s2">&quot;gray&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
                <span class="c1"># print(sum(nvv[v, :] / sum(nvv)))</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">nvv</span><span class="p">[</span><span class="mi">14</span><span class="p">],</span> <span class="s2">&quot;.--&quot;</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s2">&quot;gray&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;v=4-14&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="o">-</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">3.1</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="o">-</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">ceil</span><span class="p">(</span><span class="n">nvv</span><span class="o">.</span><span class="n">max</span><span class="p">())</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;Vibrational Number $v$&#39;&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;Contribution to $n_</span><span class="si">{d}</span><span class="s2">(v$&#39;$)$ from $n_</span><span class="si">{X}</span><span class="s2">(v)$&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mf">0.85</span><span class="p">])</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span><span class="o">.</span><span class="n">set_size_inches</span><span class="p">([</span><span class="mi">8</span><span class="p">,</span> <span class="mi">5</span><span class="p">])</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mf">1.03</span><span class="p">,</span>
            <span class="sa">f</span><span class="s2">&quot;$T_</span><span class="se">{{</span><span class="s2">vib</span><span class="se">}}</span><span class="s2">$=</span><span class="si">{</span><span class="n">Tvib</span><span class="si">}</span><span class="s2">K, isotop=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">isotop</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="n">transform</span><span class="o">=</span><span class="n">ax</span><span class="o">.</span><span class="n">transAxes</span><span class="p">,</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="CoronaModel.coronal_fit_formula"><a class="viewcode-back" href="../../fulcheranalyzer.coronalmodel.html#fulcheranalyzer.coronalmodel.CoronaModel.coronal_fit_formula">[docs]</a>    <span class="k">def</span> <span class="nf">coronal_fit_formula</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">_</span><span class="o">=</span><span class="p">[],</span> <span class="n">Tvib</span><span class="o">=</span><span class="mi">8000</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.57</span><span class="p">,</span> <span class="n">beta</span><span class="o">=</span><span class="mf">0.33</span><span class="p">,</span> <span class="n">Trot1</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span> <span class="n">Trot2</span><span class="o">=</span><span class="mi">1000</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; </span>
<span class="sd">        Fit formula for Coronal Model. </span>
<span class="sd">        Updates nxbp based on the input, returns flat array with d-state population</span>
<span class="sd">        for avaliable Q-branch lines.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        Tvib: float</span>
<span class="sd">            X-state vibrational temperature</span>
<span class="sd">        Trot1: float</span>
<span class="sd">            X-state low rotational temperature</span>
<span class="sd">        Trot2: float</span>
<span class="sd">            X-state high rotational temperature</span>
<span class="sd">        alpha: float</span>
<span class="sd">            exponent mixing coefficient for v=0</span>
<span class="sd">        beta: float</span>
<span class="sd">            exponent mixing coefficient for v&gt;0</span>
<span class="sd">        const: float</span>
<span class="sd">            constant multiplyer for the distribution</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">alpha</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bp</span><span class="o">.</span><span class="n">popt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">beta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bp</span><span class="o">.</span><span class="n">popt</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">Trot1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bp</span><span class="o">.</span><span class="n">trot1</span>
        <span class="n">Trot2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bp</span><span class="o">.</span><span class="n">trot2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">calc_ndx</span><span class="p">(</span><span class="n">Tvib</span><span class="p">,</span> <span class="n">Trot1</span><span class="p">,</span> <span class="n">Trot2</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">beta</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">fit</span> <span class="o">=</span> <span class="n">flatdf</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nd</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">bp</span><span class="o">.</span><span class="n">mask</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">fit</span> <span class="o">/</span> <span class="n">fit</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span></div>

<div class="viewcode-block" id="CoronaModel.coronal_autofit"><a class="viewcode-back" href="../../fulcheranalyzer.coronalmodel.html#fulcheranalyzer.coronalmodel.CoronaModel.coronal_autofit">[docs]</a>    <span class="k">def</span> <span class="nf">coronal_autofit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Run all the neccessary steps with default settings</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">scipy.optimize</span> <span class="kn">import</span> <span class="n">curve_fit</span>

        <span class="c1"># p = [3000,0.3,0.3,200,1000]</span>
        <span class="c1"># bounds = [[3000,0.1,0.01,150,800],[15000,0.99,0.7,1000,6000]]</span>
        <span class="n">p</span> <span class="o">=</span> <span class="p">[</span><span class="mi">3000</span><span class="p">]</span>
        <span class="n">bounds</span> <span class="o">=</span> <span class="p">[[</span><span class="mi">3000</span><span class="p">],</span> <span class="p">[</span><span class="mi">15000</span><span class="p">]]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">param</span> <span class="o">=</span> <span class="n">p</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bounds</span> <span class="o">=</span> <span class="n">bounds</span>

        <span class="n">ndexp</span> <span class="o">=</span> <span class="n">flatdf</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bp</span><span class="o">.</span><span class="n">nd</span><span class="p">)</span>  <span class="c1"># experimental data, normalized by the sum</span>
        <span class="n">nd_err</span> <span class="o">=</span> <span class="n">flatdf</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bp</span><span class="o">.</span><span class="n">nd_err</span><span class="p">)</span>  <span class="c1"># experimental error</span>
        <span class="n">nd_err</span> <span class="o">=</span> <span class="n">nd_err</span> <span class="o">/</span> <span class="n">ndexp</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">ndexp</span> <span class="o">=</span> <span class="n">ndexp</span> <span class="o">/</span> <span class="n">ndexp</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">fitres</span><span class="p">,</span> <span class="n">cov</span> <span class="o">=</span> <span class="n">curve_fit</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">coronal_fit_formula</span><span class="p">,</span>
            <span class="p">[],</span>
            <span class="n">ndexp</span><span class="p">,</span>
            <span class="n">p0</span><span class="o">=</span><span class="n">p</span><span class="p">,</span>
            <span class="n">bounds</span><span class="o">=</span><span class="n">bounds</span><span class="p">,</span>
            <span class="n">sigma</span><span class="o">=</span><span class="n">nd_err</span><span class="p">,</span>
            <span class="n">absolute_sigma</span><span class="o">=</span><span class="n">ABSOLUTESIGMA</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">err</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">cov</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tvib</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fitres</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tviberr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">err</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">print_coronal_fit_result</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">calc_errorbars</span><span class="p">()</span></div>

<div class="viewcode-block" id="CoronaModel.print_coronal_fit_result"><a class="viewcode-back" href="../../fulcheranalyzer.coronalmodel.html#fulcheranalyzer.coronalmodel.CoronaModel.print_coronal_fit_result">[docs]</a>    <span class="k">def</span> <span class="nf">print_coronal_fit_result</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Print coronal fit result</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Tvib&quot;</span><span class="p">,</span> <span class="s2">&quot;alpha&quot;</span><span class="p">,</span> <span class="s2">&quot;beta&quot;</span><span class="p">,</span> <span class="s2">&quot;Trot1&quot;</span><span class="p">,</span> <span class="s2">&quot;Trot2&quot;</span><span class="p">]</span>
        <span class="n">pr</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
        <span class="nb">print</span><span class="p">(</span>
            <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="p">[</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">names</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="s2"> = </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">fitres</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">:</span><span class="s2">.</span><span class="si">{</span><span class="n">pr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="s2">f</span><span class="si">}</span><span class="s2"> +- </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">err</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">:</span><span class="s2">.</span><span class="si">{</span><span class="n">pr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="s2">f</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">param</span><span class="p">))</span>
                <span class="p">]</span>
            <span class="p">)</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="CoronaModel.get_nxbp"><a class="viewcode-back" href="../../fulcheranalyzer.coronalmodel.html#fulcheranalyzer.coronalmodel.CoronaModel.get_nxbp">[docs]</a>    <span class="k">def</span> <span class="nf">get_nxbp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Tvib</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; </span>
<span class="sd">        Updated CoronaModelIshihara-s nxbp for given Tvib, return it</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">alpha</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bp</span><span class="o">.</span><span class="n">popt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">beta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bp</span><span class="o">.</span><span class="n">popt</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">Trot1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bp</span><span class="o">.</span><span class="n">trot1</span>
        <span class="n">Trot2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bp</span><span class="o">.</span><span class="n">trot2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">calc_ndx</span><span class="p">(</span><span class="n">Tvib</span><span class="p">,</span> <span class="n">Trot1</span><span class="p">,</span> <span class="n">Trot2</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">beta</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">nxbp</span></div>

<div class="viewcode-block" id="CoronaModel.calc_errorbars"><a class="viewcode-back" href="../../fulcheranalyzer.coronalmodel.html#fulcheranalyzer.coronalmodel.CoronaModel.calc_errorbars">[docs]</a>    <span class="k">def</span> <span class="nf">calc_errorbars</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Tvib</span><span class="o">=</span><span class="mi">8000</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate error bars for flat and full population plots</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">corer</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">coronal_fit_formula</span><span class="p">([],</span> <span class="o">*</span><span class="p">[</span><span class="n">t</span><span class="p">])</span>
                <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">tvib</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">tviberr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tvib</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">tviberr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tvib</span><span class="p">]</span>
            <span class="p">]</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">yerr_flat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">absolute</span><span class="p">(</span><span class="n">corer</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">corer</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

        <span class="n">em</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_nxbp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tvib</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">tviberr</span><span class="p">)</span>
        <span class="n">ep</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_nxbp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tvib</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">tviberr</span><span class="p">)</span>
        <span class="n">val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_nxbp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tvib</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">yerr_rot</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;plus&quot;</span><span class="p">:</span> <span class="n">ep</span><span class="p">,</span> <span class="s2">&quot;minus&quot;</span><span class="p">:</span> <span class="n">em</span><span class="p">,</span> <span class="s2">&quot;val&quot;</span><span class="p">:</span> <span class="n">val</span><span class="p">}</span></div>

<div class="viewcode-block" id="CoronaModel.plot_popx_paper"><a class="viewcode-back" href="../../fulcheranalyzer.coronalmodel.html#fulcheranalyzer.coronalmodel.CoronaModel.plot_popx_paper">[docs]</a>    <span class="k">def</span> <span class="nf">plot_popx_paper</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">11</span><span class="p">,</span> <span class="n">ms</span><span class="o">=</span><span class="mi">4</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot X-state population (figs 9-10)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">matplotlib.pylab</span> <span class="k">as</span> <span class="nn">plt</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">prep_style</span><span class="p">(</span><span class="n">ms</span><span class="o">=</span><span class="n">ms</span><span class="p">)</span>
        <span class="n">kws</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">style_rovib</span>
        <span class="p">[</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">EX</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">yerr_rot</span><span class="p">[</span><span class="s2">&quot;minus&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">nxbp</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">yerr_rot</span><span class="p">[</span><span class="s2">&quot;plus&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">nxbp</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
                <span class="n">color</span><span class="o">=</span><span class="s2">&quot;gray&quot;</span><span class="p">,</span>
                <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
                <span class="n">ec</span><span class="o">=</span><span class="s2">&quot;none&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">yerr_rot</span><span class="p">[</span><span class="s2">&quot;minus&quot;</span><span class="p">]</span>
        <span class="p">]</span>
        <span class="p">[</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">EX</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">nxbp</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">nxbp</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="o">**</span><span class="n">kws</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nxbp</span>
        <span class="p">]</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">fill_between</span><span class="p">([],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;gray&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;error&quot;</span><span class="p">,</span> <span class="n">ec</span><span class="o">=</span><span class="s2">&quot;none&quot;</span><span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">yscale</span><span class="p">(</span><span class="s2">&quot;log&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Rotational Energy [eV]&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span>
            <span class="s2">&quot;$</span><span class="se">\\</span><span class="s2">mathdefault{\mathrm{</span><span class="se">\\</span><span class="s2">frac{n_</span><span class="si">{XvN}</span><span class="s2">}{(2N+1)g_</span><span class="si">{as}</span><span class="s2">^</span><span class="si">{N}</span><span class="s2">}}}}$ [a.u.]&quot;</span><span class="p">,</span>
            <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">EX</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mf">0.02</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">,</span> <span class="s2">&quot;N=0&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">EX</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mf">1.05</span><span class="p">,</span>
            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">yerr_rot</span><span class="p">[</span><span class="s2">&quot;minus&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">nxbp</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mf">0.02</span><span class="p">,</span>
            <span class="sa">f</span><span class="s2">&quot;N=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">popshape</span><span class="p">[</span><span class="s1">&#39;jxmax&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="n">ha</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span>
            <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span> <span class="o">-</span> <span class="mi">2</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="o">-</span><span class="mf">0.05</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span><span class="o">.</span><span class="n">set_size_inches</span><span class="p">(</span><span class="n">figsize</span><span class="p">(</span><span class="mi">8</span><span class="p">))</span></div></div>


<span class="c1"># ==================================================</span>
<span class="c1">#</span>
<span class="c1">#  Coronal Model Functions without any data references</span>
<span class="c1">#  Put here, outside of the class.</span>
<span class="c1"># ==================================================</span>


<div class="viewcode-block" id="delta_kro"><a class="viewcode-back" href="../../fulcheranalyzer.coronalmodel.html#fulcheranalyzer.coronalmodel.delta_kro">[docs]</a><span class="k">def</span> <span class="nf">delta_kro</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; </span>
<span class="sd">    Kronecker-s delta  https://en.wikipedia.org/wiki/Kronecker_delta</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">a</span> <span class="o">==</span> <span class="n">b</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">0</span></div>


<div class="viewcode-block" id="g_as"><a class="viewcode-back" href="../../fulcheranalyzer.coronalmodel.html#fulcheranalyzer.coronalmodel.g_as">[docs]</a><span class="k">def</span> <span class="nf">g_as</span><span class="p">(</span><span class="n">J</span><span class="p">,</span> <span class="n">isotop</span><span class="o">=</span><span class="s2">&quot;d&quot;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Spin multiplicity, or stat. weight, </span>
<span class="sd">    formula for rotational q.n. J for H2 or D2</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">isotop</span> <span class="o">==</span> <span class="s2">&quot;d&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">6</span> <span class="o">-</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">mod</span><span class="p">(</span><span class="n">J</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">isotop</span> <span class="o">==</span> <span class="s2">&quot;h&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">mod</span><span class="p">(</span><span class="n">J</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span></div>


<div class="viewcode-block" id="g_as_vector"><a class="viewcode-back" href="../../fulcheranalyzer.coronalmodel.html#fulcheranalyzer.coronalmodel.g_as_vector">[docs]</a><span class="k">def</span> <span class="nf">g_as_vector</span><span class="p">(</span><span class="n">Jlen</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> <span class="n">isotop</span><span class="o">=</span><span class="s2">&quot;d&quot;</span><span class="p">,</span> <span class="n">transpose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">j0</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    calculate g_as vector</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">gvect</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">g_as</span><span class="p">(</span><span class="n">J</span><span class="p">,</span> <span class="n">isotop</span><span class="o">=</span><span class="n">isotop</span><span class="p">)</span> <span class="k">for</span> <span class="n">J</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">j0</span><span class="p">,</span> <span class="n">Jlen</span> <span class="o">+</span> <span class="n">j0</span><span class="p">)])</span>
    <span class="k">if</span> <span class="n">transpose</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">gvect</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">gvect</span></div>


<div class="viewcode-block" id="tjpo_vector"><a class="viewcode-back" href="../../fulcheranalyzer.coronalmodel.html#fulcheranalyzer.coronalmodel.tjpo_vector">[docs]</a><span class="k">def</span> <span class="nf">tjpo_vector</span><span class="p">(</span><span class="n">Jlen</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> <span class="n">transpose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">j0</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; </span>
<span class="sd">    vector (2(Jind+1)+1)</span>
<span class="sd">    d-state: j0=1</span>
<span class="sd">    X-state: j0=0</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">transpose</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">2</span> <span class="o">*</span> <span class="n">J</span> <span class="o">+</span> <span class="mi">1</span> <span class="k">for</span> <span class="n">J</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">j0</span><span class="p">,</span> <span class="n">Jlen</span> <span class="o">+</span> <span class="n">j0</span><span class="p">)])[:,</span> <span class="kc">None</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">2</span> <span class="o">*</span> <span class="n">J</span> <span class="o">+</span> <span class="mi">1</span> <span class="k">for</span> <span class="n">J</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">j0</span><span class="p">,</span> <span class="n">Jlen</span> <span class="o">+</span> <span class="n">j0</span><span class="p">)])</span></div>


<div class="viewcode-block" id="reshape_4d2d"><a class="viewcode-back" href="../../fulcheranalyzer.coronalmodel.html#fulcheranalyzer.coronalmodel.reshape_4d2d">[docs]</a><span class="k">def</span> <span class="nf">reshape_4d2d</span><span class="p">(</span><span class="n">matrix</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Reshape 4d numpy array into 2d</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">d</span> <span class="o">=</span> <span class="n">matrix</span><span class="o">.</span><span class="n">shape</span>
    <span class="k">return</span> <span class="n">matrix</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">a</span> <span class="o">*</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span> <span class="o">*</span> <span class="n">d</span><span class="p">)</span></div>


<div class="viewcode-block" id="plot_rmatrix"><a class="viewcode-back" href="../../fulcheranalyzer.coronalmodel.html#fulcheranalyzer.coronalmodel.plot_rmatrix">[docs]</a><span class="k">def</span> <span class="nf">plot_rmatrix</span><span class="p">(</span><span class="n">Rm</span><span class="p">,</span> <span class="n">shapes</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="s2">&quot;R-matrix&quot;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Plot 2d R matrix for inspection </span>
<span class="sd">    vdl, jdl, vxl, jxl = shapes</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">matplotlib</span> <span class="k">as</span> <span class="nn">mpl</span>
    <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
    <span class="kn">from</span> <span class="nn">mpl_toolkits.axes_grid1</span> <span class="kn">import</span> <span class="n">make_axes_locatable</span>

    <span class="n">vdl</span><span class="p">,</span> <span class="n">jdl</span><span class="p">,</span> <span class="n">vxl</span><span class="p">,</span> <span class="n">jxl</span> <span class="o">=</span> <span class="n">shapes</span>
    <span class="n">xticks</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">vxl</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">jxl</span>
    <span class="n">yticks</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">vdl</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">jdl</span>
    <span class="c1"># Color Map with Under and Over defined</span>
    <span class="n">cm</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">seismic</span>
    <span class="n">cm</span><span class="o">.</span><span class="n">set_under</span><span class="p">(</span><span class="s2">&quot;#736200&quot;</span><span class="p">)</span>
    <span class="n">cm</span><span class="o">.</span><span class="n">set_over</span><span class="p">(</span><span class="s2">&quot;#15ad1a&quot;</span><span class="p">)</span>

    <span class="n">im</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">Rm</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s2">&quot;lower&quot;</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cm</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">mpl</span><span class="o">.</span><span class="n">colors</span><span class="o">.</span><span class="n">LogNorm</span><span class="p">())</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>
    <span class="c1"># Colorbar in a divider axis</span>
    <span class="n">divider</span> <span class="o">=</span> <span class="n">make_axes_locatable</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>
    <span class="n">cax</span> <span class="o">=</span> <span class="n">divider</span><span class="o">.</span><span class="n">append_axes</span><span class="p">(</span><span class="s2">&quot;right&quot;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="s2">&quot;5%&quot;</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">extend</span><span class="o">=</span><span class="s2">&quot;both&quot;</span><span class="p">,</span> <span class="n">cax</span><span class="o">=</span><span class="n">cax</span><span class="p">)</span>

    <span class="c1"># Text</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">sca</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_aspect</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_facecolor</span><span class="p">(</span><span class="s2">&quot;#a8a594&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">xticks</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">(</span><span class="n">yticks</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;$v\cdot J$ ($X^1\Sigma^+_g$)&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;$v$&#39;$\cdot (J$&#39;$-1)$ ($d^3\Pi_</span><span class="si">{u}</span><span class="s2">$)&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">xticks</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">yticks</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">c</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span>
        <span class="o">-</span><span class="mf">0.12</span><span class="p">,</span>
        <span class="mi">0</span><span class="p">,</span>
        <span class="sa">f</span><span class="s2">&quot;$vd\cdot Jd = </span><span class="si">{</span><span class="n">vdl</span><span class="si">}</span><span class="s2">\cdot </span><span class="si">{</span><span class="n">jdl</span><span class="si">}</span><span class="s2">$&quot;</span><span class="p">,</span>
        <span class="n">transform</span><span class="o">=</span><span class="n">ax</span><span class="o">.</span><span class="n">transAxes</span><span class="p">,</span>
        <span class="n">rotation</span><span class="o">=</span><span class="mi">90</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span>
        <span class="o">-</span><span class="mf">0.12</span><span class="p">,</span>
        <span class="mf">0.75</span><span class="p">,</span>
        <span class="sa">f</span><span class="s2">&quot;$</span><span class="se">\\</span><span class="s2">nexists Jd = 0$, $Jd&gt;0$!!!&quot;</span><span class="p">,</span>
        <span class="n">transform</span><span class="o">=</span><span class="n">ax</span><span class="o">.</span><span class="n">transAxes</span><span class="p">,</span>
        <span class="n">rotation</span><span class="o">=</span><span class="mi">90</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="o">-</span><span class="mf">0.12</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.1</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;$vx\cdot Jx = </span><span class="si">{</span><span class="n">vxl</span><span class="si">}</span><span class="s2">\cdot </span><span class="si">{</span><span class="n">jxl</span><span class="si">}</span><span class="s2">$&quot;</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">ax</span><span class="o">.</span><span class="n">transAxes</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.7</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.1</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">text</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">ax</span><span class="o">.</span><span class="n">transAxes</span><span class="p">)</span>

    <span class="p">[</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">vxl</span> <span class="o">*</span> <span class="n">jxl</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="n">j</span> <span class="o">+</span> <span class="n">jdl</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">yticks</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="p">]</span>
    <span class="p">[</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">j</span> <span class="o">+</span> <span class="n">jxl</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">vdl</span> <span class="o">*</span> <span class="n">jdl</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">xticks</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="p">]</span></div>


<span class="c1"># Which of two are best for flattening DataFrame containing nans?</span>
<span class="c1"># flatdf seems to bee 2-times faster, 600 micros vs 1.8 ms for 4x15 matrix</span>


<div class="viewcode-block" id="flatdf"><a class="viewcode-back" href="../../fulcheranalyzer.coronalmodel.html#fulcheranalyzer.coronalmodel.flatdf">[docs]</a><span class="k">def</span> <span class="nf">flatdf</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="s2">&quot;f&quot;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Flatten a DataFrame with nans into np.array()</span>
<span class="sd">   </span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>

<span class="sd">    order: list</span>
<span class="sd">        order = [&#39;f&#39;,&#39;c&#39;], see numpy.ndarray.flatten</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">order</span><span class="o">=</span><span class="s2">&quot;f&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span></div>


<div class="viewcode-block" id="flatdf_1"><a class="viewcode-back" href="../../fulcheranalyzer.coronalmodel.html#fulcheranalyzer.coronalmodel.flatdf_1">[docs]</a><span class="k">def</span> <span class="nf">flatdf_1</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;val&quot;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; </span>
<span class="sd">    Flatten DataFrame, remove nans, reset index. Good for fitting.</span>
<span class="sd">    Consistently returns 1d array. Order is Column-wise, or &#39;f&#39;.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">melt</span><span class="p">(</span><span class="n">value_name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
    <span class="k">del</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;variable&quot;</span><span class="p">]</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">df</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">values</span></div>


<div class="viewcode-block" id="figsize"><a class="viewcode-back" href="../../fulcheranalyzer.coronalmodel.html#fulcheranalyzer.coronalmodel.figsize">[docs]</a><span class="k">def</span> <span class="nf">figsize</span><span class="p">(</span><span class="n">width</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">ratio</span><span class="o">=</span><span class="mi">5</span> <span class="o">/</span> <span class="mi">6</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate image size from width in cm</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">cm_to_inch</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="mf">2.54</span>
    <span class="c1"># -0.05 - adjust for padding when saving.</span>
    <span class="c1"># For some reason savefig adds more padding, then savefig.pad_inches: 0.05</span>
    <span class="n">pad</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.2</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">width</span> <span class="o">*</span> <span class="n">cm_to_inch</span> <span class="o">+</span> <span class="n">pad</span><span class="p">,</span> <span class="p">(</span><span class="n">width</span> <span class="o">*</span> <span class="n">cm_to_inch</span> <span class="o">+</span> <span class="n">pad</span><span class="p">)</span> <span class="o">*</span> <span class="n">ratio</span><span class="p">)</span></div>


<div class="viewcode-block" id="set_tick_size"><a class="viewcode-back" href="../../fulcheranalyzer.coronalmodel.html#fulcheranalyzer.coronalmodel.set_tick_size">[docs]</a><span class="k">def</span> <span class="nf">set_tick_size</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="o">*</span><span class="n">size</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; </span>
<span class="sd">    Set matplotlib axis tick sizes</span>
<span class="sd">    For some reason the length from style is ignored.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">width_major</span><span class="p">,</span> <span class="n">length_major</span><span class="p">,</span> <span class="n">width_minor</span><span class="p">,</span> <span class="n">length_minor</span> <span class="o">=</span> <span class="n">size</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_tick_params</span><span class="p">(</span><span class="n">width</span><span class="o">=</span><span class="n">width_major</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="n">length_major</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="s2">&quot;major&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_tick_params</span><span class="p">(</span><span class="n">width</span><span class="o">=</span><span class="n">width_minor</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="n">length_minor</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="s2">&quot;minor&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_tick_params</span><span class="p">(</span><span class="n">width</span><span class="o">=</span><span class="n">width_major</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="n">length_major</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="s2">&quot;major&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_tick_params</span><span class="p">(</span><span class="n">width</span><span class="o">=</span><span class="n">width_minor</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="n">length_minor</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="s2">&quot;minor&quot;</span><span class="p">)</span></div>
</pre></div>

              </article>
              

              
              <footer class="bd-footer-article">
                  <!-- Previous / next buttons -->
<div class='prev-next-area'>
</div>
              </footer>
              
          </div>
          
      </div>
    </div>

  
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../_static/scripts/pydata-sphinx-theme.js?digest=92025949c220c2e29695"></script>

<footer class="bd-footer"><div class="bd-footer__inner container">
  
  <div class="footer-item">
    <p class="copyright">
    &copy; Copyright 2022, A.K..<br>
</p>
  </div>
  
  <div class="footer-item">
    <p class="sphinx-version">
Created using <a href="http://sphinx-doc.org/">Sphinx</a> 4.4.0.<br>
</p>
  </div>
  
</div>
</footer>
  </body>
</html>